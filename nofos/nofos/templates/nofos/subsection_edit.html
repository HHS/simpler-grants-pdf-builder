{% extends 'base.html' %}
{% load static nofo_name input_type whitespaceless safe_br %}

{% block title %}
  Subsection: {% if subsection.name %}{{ subsection.name }}{% else %}(#{{ subsection.order }}){% endif %}
{% endblock %}

{% block css %}
  <link href="{% static 'plugins/css/bootstrap.min.css' %}" type="text/css" media="all" rel="stylesheet">
  <link href="{% static 'plugins/css/ace.min.css' %}" type="text/css" media="all" rel="stylesheet">
  <link href="{% static 'martor/css/martor.bootstrap.min.css' %}" type="text/css" media="all" rel="stylesheet">
{% endblock %}

{% block js %}
  <script src="{% static 'js/nofos/subsection_edit.js' %}" defer></script>
{% endblock %}

{% block body_class %}subsection_edit{% endblock %}

{% block content %}
  {% with nofo|nofo_name as nofo_name_str %}
    <div class="back-link font-body-md margin-bottom-105">
      <a class="usa-button--icon--before usa-button--icon--usa-blue usa-button--arrow_back" href="{% url 'nofos:nofo_edit' nofo.id %}#{{ subsection.html_id }}">Edit ‚Äú{{ nofo_name_str }}‚Äù</a>
    </div>
    <div class="subsection_edit--header">
      <h1 class="font-heading-xl margin-y-0">Subsection: {% if subsection.name %}{{ subsection.name|safe_br }}{% else %}(#{{ subsection.order }}){% endif %}</h1>
      {% if subsection.callout_box %}<h2 class="font-heading-lg margin-y-1 text-base"><span aria-hidden="true">üì¶</span> Callout box</h2>{% endif %}
      {% if subsection.name %}
      <div class="subsection_edit--header--view font-sans-md">
        <a href="{% url 'nofos:nofo_view' nofo.id %}{{ "#"|add:subsection.html_id  }}" target="_blank">View HTML for subsection</a>
      </div>
      {% endif %}
    </div>
  {% endwith %}

  <p>Edit page for this subsection.</p>

  {% if nofo.modifications %}
    {% if subsection.section.name|lower == 'modifications' %}
      {% if subsection.order == 1 %}
        <h2 class="font-serif-md margin-top-4">Modifications date</h2>
        <div class="previous-subsection-widget outline-box">
          <p class="outline-box--heading text-base-dark">Last modified date: September 13, 2024</p>
          <p class="outline-box--content">
            <a href="{% url 'nofos:nofo_modifications' nofo.id %}" class="usa-link usa-link--external" target="blank" title="Edit modifications date (Opens in a new tab)">
              Edit date
            </a>
          </p>
        </div>

        <h2 class="font-serif-lg margin-top-5 margin-bottom-0">Edit modifications table</h2>
      {% endif %}
    {% endif %}
  {% endif %}

  <form class="form" method="post">
    {% csrf_token %}
    <fieldset class="usa-fieldset">

      {% if form.non_field_errors %}
        <legend class="legend--bootstrap">
          <div class="usa-error-message">
            Error: {{ form.non_field_errors.0 }}
          </div>
        </legend>
      {% endif %}

      <input type="hidden" name="{{ form.callout_box.name }}" id="{{ form.callout_box.id_for_label }}" value="{{ subsection.callout_box }}">

      <!-- name -->
      <div class="form-group">
        {% with id="name" label=form.name.label value=form.name.value hint=form.name.help_text error=form.name.errors.0 input_type=form.name|input_type %}
          {% if subsection.tag %}
            {% include "includes/_text_input.html" with id=id label=label value=value error=error input_type=input_type safe_hint=True only %}
            {% if subsection.html_id %}
              <div class="usa-hint margin-top-05 hint--subsection-id" id="{{ id }}--hint-2">
                <span id="subsection-html_id">{{ "#"|add:subsection.html_id  }}</span>
                <button type="button" class="usa-button usa-button--outline" id="subsection-html_id--button">
                  Copy
                </button>
              </div>
            {% endif %}
          {% else %}
            {% include "includes/_text_input.html" with id=id label=label value=value error=error input_type=input_type disabled="disabled" only %}
          {% endif %}
        {% endwith %}
      </div>

      <!-- tag -->
      {% if not form.tag.value %}

        {# if there is no tag, make this a hidden field #}
        <input type="hidden" name="{{ form.tag.name }}" id="{{ form.tag.id_for_label }}" value="{{ subsection.tag }}">

      {% else %}

        <div class="form-group width-mobile">
          <label
            {% whitespaceless %}
                class="
                  usa-label
                    {% if form.errors.tag %}
                      text-secondary-dark
                    {% endif %}
                "
          {% endwhitespaceless %} for="tag">Heading level</label>
          {% if form.errors.tag %}
            <div class="usa-error-message" id="tag--error">
              {{ form.errors.tag.0 }}
            </div>
          {% endif %}
          <select {% whitespaceless %}
            class="
                  usa-select
                  border-2px
                    {% if form.errors.tag %}
                      border-secondary-dark
                    {% endif %}
                "
          {% endwhitespaceless %} class="usa-select border-2px" name="tag" id="tag" {% if form.errors.tag %}aria-describedby="tag--error"{% endif %}>
            <option value="h3" {% if form.tag.value == 'h3' %}selected{% endif %}>Heading 3</option>
            <option value="h4" {% if form.tag.value == 'h4' %}selected{% endif %}>Heading 4</option>
            <option value="h5" {% if form.tag.value == 'h5' %}selected{% endif %}>Heading 5</option>
            <option value="h6" {% if form.tag.value == 'h6' %}selected{% endif %}>Heading 6</option>
            <option value="h7" {% if form.tag.value == 'h7' %}selected{% endif %}>Heading 7</option>
          </select>
        </div>
      {% endif %}

      <!-- html_class -->
      <div class="form-group margin-top-4">
        <fieldset class="usa-fieldset">
          {# Show a warning if html_class is some unexpected value #}
          {% with current_class=form.html_class.value|default_if_none:'' %}
            {% if current_class and current_class != 'page-break-before' %}
              <div class="padding-05 padding-left-1 border-solid border-top-width-0 border-bottom-width-0 border-right-width-0 border-left-width-05 border-accent-warm-dark text-accent-warm-dark">
                <span aria-hidden="true">‚ö†Ô∏è</span>
                Warning! This heading‚Äôs class is ‚Äò{{ current_class }}‚Äô. If you change this, the existing class will be overwritten.
              </div>
            {% endif %}
          {% endwith %}

          {# Hidden input ensures we submit "" when the checkbox is unchecked #}
          <input type="hidden" name="html_class" value="">

          <div class="usa-checkbox width-mobile">
            <input
              class="usa-checkbox__input usa-checkbox__input--tile"
              id="page-break-before"
              type="checkbox"
              name="html_class"
              value="page-break-before"
              {% if form.html_class.value == 'page-break-before' %}
                checked
              {% endif %}
            />
            <label class="usa-checkbox__label" for="page-break-before">
              Add a page break
              <span class="usa-checkbox__label-description">
                Start this subsection on a new page in the PDF.
              </span>
            </label>
          </div>
        </fieldset>
      </div>

      <!-- body -->
      <div class="form-group">
        <div class="main-martor--container margin-top-4">
          <label class="usa-label usa-sr-only" for="{{ form.body.id_for_label }}">Subsection content</label>
          {{ form.body }}
        </div>
      </div>
    </fieldset>
    <div class="form-group">
      <button class="usa-button margin-top-3" type="submit">Save subsection</button>
    </div>
  </form>

  <hr class="margin-top-3 margin-bottom-5" />

  <details class="usa-accordion usa-accordion--bordered">
    <summary class="usa-accordion__button">
      <h2 class="usa-accordion--heading">
        Other actions
      </h2>
    </summary>

    <div class="usa-accordion__content usa-prose">
      <ul class="usa-list usa-list--unstyled">
        <li>
          <a class="usa-button usa-button--green" href="{% url 'nofos:subsection_create' nofo.id subsection.section.id %}?prev_subsection={{subsection.id}}">
            Add subsection
          </a> ‚Äî add a new subsection after this one
        </li>
        <li>
          <a class="usa-button usa-button--secondary" href="{% url 'nofos:subsection_delete' nofo.id subsection.section.id subsection.id %}">
            Delete subsection
          </a> ‚Äî remove this subsection completely
        </li>
      </ul>
    </div>
  </details>
{% endblock %}

{% block js_footer %}
  <script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/jquery.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/bootstrap.min.js' %}"></script>

  <script type="text/javascript" src="{% static 'plugins/js/ace.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/mode-markdown.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/ext-language_tools.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/theme-github.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/typo.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/spellcheck.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/highlight.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/js/emojis.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'martor/js/martor.bootstrap.min.js' %}"></script>
{% endblock %}
