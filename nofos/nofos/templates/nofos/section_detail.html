{% extends 'base.html' %}
{% load martortags nofo_name get_value_or_none add_classes_to_tables convert_paragraphs_to_hrs %}


{% block title %}
  Add or remove subsections for {{ section.name }}
{% endblock %}

{% block body_class %}section_edit{% endblock %}

{% block content %}
<div class="back-link font-body-md margin-bottom-105">
  <a href="{% url 'nofos:nofo_edit' nofo.id %}">Edit ‚Äú{{ nofo|nofo_name }}‚Äù</a>
</div>
<div class="section_edit--header">
  <h1 class="font-heading-xl margin-y-1">Configure section <span class="usa-sr-only"> for {{ section.name }}</span></h1>
  <h2 class="font-heading-lg margin-y-1 text-base" aria-hidden="true">{{ section.name }}</h2>
</div>

{% if nofo.status != 'published' and nofo.status != 'cancelled' and not nofo.archived %}
<div
  class="usa-summary-box margin-top-4"
  role="region"
  aria-labelledby="summary-box-key-information"
>
  <div class="usa-summary-box__body">
    <h4 class="usa-summary-box__heading" id="summary-box-key-information">
      Section options
    </h4>
    <div class="usa-summary-box__text">
      <div class="usa-checkbox">
        <input class="usa-checkbox__input"
               id="toggle-tables-checkbox"
               name="toggle-tables"
               type="checkbox"
               value="full-width"
               data-url="{% url 'nofos:section_toggle_tables' section.nofo.id section.id %}"
               data-csrf-token="{{ csrf_token }}"
               {% if section.html_class and 'section--tables-full-width' in section.html_class %}checked{% endif %}>
        <label class="usa-checkbox__label" for="toggle-tables-checkbox">
          Use full-width tables for this section
        </label>
      </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleCheckbox = document.getElementById('toggle-tables-checkbox');

        toggleCheckbox.addEventListener('change', function() {
            // Disable checkbox during request
            toggleCheckbox.disabled = true;
            const originalChecked = toggleCheckbox.checked;

            fetch(toggleCheckbox.dataset.url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': toggleCheckbox.dataset.csrfToken,
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update checkbox state and tooltip based on response
                    const state = data.state;
                    if (state === 'default') {
                        toggleCheckbox.checked = false;
                    } else {
                        toggleCheckbox.checked = true;
                    }

                    showMessage(data.message, 'success');
                } else {
                    const message = data.message || 'An error occurred. Please try again.';
                    showMessage(message, 'error');
                    // Revert checkbox state on error
                    toggleCheckbox.checked = originalChecked;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred. Please try again.', 'error');
                // Revert checkbox state on error
                toggleCheckbox.checked = originalChecked;
            })
            .finally(() => {
                toggleCheckbox.disabled = false;
                toggleCheckbox.focus();
            });
        });

        function showMessage(message, type) {
            // Create a simple message div
            const messageDiv = document.createElement('div');
            messageDiv.className = `usa-alert usa-alert--${type === 'success' ? 'success' : 'error'} usa-alert--slim margin-top-2`;
            messageDiv.innerHTML = `
                <div class="usa-alert__body">
                    <p class="usa-alert__text">${message}</p>
                </div>
            `;

            // Insert after the summary box
            const summaryBox = document.querySelector('.usa-summary-box');
            summaryBox.parentNode.insertBefore(messageDiv, summaryBox.nextSibling);

            // Remove message after 4 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 4000);
        }
    });
    </script>
  </div>
</div>
{% endif %}

<div class="margin-top-4">
  <details class="usa-accordion usa-accordion--bordered" open>
    <summary class="usa-accordion__button">
      <h3 class="usa-accordion--heading margin-top-0">
        Other sections
      </h3>
    </summary>

    <div class="usa-accordion__content usa-prose">
      <div class="edit_section--other_sections">
        {% if section.get_previous_section %}
          <a href="{% url 'nofos:section_detail' section.nofo.id section.get_previous_section.id %}" class="section_edit--previous-section">{{ section.get_previous_section.name }}</a>
        {% endif %}

        {% if section.get_next_section %}
          <a href="{% url 'nofos:section_detail' section.nofo.id section.get_next_section.id %}" class="section_edit--next-section">{{ section.get_next_section.name }}</a>
        {% endif %}
      </div>
    </div>
  </details>
</div>

<table class="usa-table usa-table--borderless width-full table--hide-edit-if-published table--section">
  <caption>
    <div>
      <h2 class="margin-bottom-0" id="{{ section.html_id }}">{{ section.name }}</h2>
    </div>
  </caption>
  <thead class="usa-sr-only">
    <tr>
      <th scope="col">Heading</th>
      <th scope="col">Is callout box</th>
      <th scope="col">Content</th>
      <th scope="col">Manage</th>
    </tr>
  </thead>
  <tbody>
    {% for subsection in section.subsections.all|dictsort:"order" %}
    <tr>
      <th scope="row"
        class="nofo-edit-table--subsection--name {% if subsection.html_class %}{{ subsection.html_class }}{% endif %}"
        id="{{ subsection.html_id }}">
        <span class="floating">
          {% if subsection.name %}
            {{ subsection.name }}
          {% else %}
            <span class="text-base">(#{{ subsection.order}})</span>
          {% endif %}
        </span>
      </th>
      <td class="nofo-edit-table--subsection--callout-box">
        {% if subsection.callout_box %}
        <span class="floating">
          <span role="img" aria-label="Callout box" title="Callout box">üì¶</span>
        </span>
        {% endif %}
      </td>
      <td class="nofo-edit-table--subsection--body">
        {{ subsection.body|safe_markdown|add_classes_to_tables|convert_paragraphs_to_hrs|get_value_or_none:"content" }}
      </td>
      <td class="nofo-edit-table--subsection--manage">
        <span class="floating">
          <a class="text-secondary-dark" href="{% url 'nofos:subsection_delete' section.nofo.id section.id subsection.id %}">
            Delete <span class="usa-sr-only"> subsection: {{ subsection.name }}</span>
          </a>
        </span>

        <a class="usa-button usa-button--outline add-button" type="button" href="{% url 'nofos:subsection_create' section.nofo.id subsection.section.id %}?prev_subsection={{subsection.id}}">
          Add subsection
        </a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<script>
  // Function to set table width CSS custom property for Safari compatibility dealing with the add-button positioning
  function setTableWidthVariable() {
      const table = document.querySelector('table.table--section');
      if (table) {
          const tableWidth = table.offsetWidth + 'px';
          document.documentElement.style.setProperty('--safari-tr-width', tableWidth);
      }
  }

  // Set table width variable on page load and window resize
  document.addEventListener('DOMContentLoaded', setTableWidthVariable);
  window.addEventListener('resize', setTableWidthVariable);
</script>
{% endblock %}
