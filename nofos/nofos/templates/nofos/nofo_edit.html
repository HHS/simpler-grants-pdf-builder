{% extends 'base.html' %}
{% load static tz martortags nofo_name subsection_name_or_order get_value_or_none add_classes_to_tables add_classes_to_links convert_paragraphs_to_hrs split_char_and_remove safe_br %}

{% block title %}
Edit “{{ nofo|nofo_name }}”
{% endblock %}

{% block js %}
  <script src="{% static 'js/nofos/nofo_edit.js' %}" defer></script>
{% endblock %}

{% block html_class %}html--nofo_edit{% endblock %}

{% block body_class %}nofo_edit nofo_status--{{ nofo.status }}{% if nofo.modifications %} nofo--modifications{% endif %}{% if nofo.archived %} nofo--archived{% endif %}{% endblock %}

{% block content %}
{% include "includes/alerts.html" with messages=messages success_heading=success_heading error_heading=error_heading stick_to_bottom=True only %}

<!-- WARNING MESSAGE FOR ARCHIVED/SUCCESSOR NOFOS -->
{% if nofo.archived %}
  {% if nofo.successor %}
    {% include "includes/warning_successor.html" with document=nofo user=user class_name="margin-bottom-3" only %}
  {% else %}
    {% include "includes/warning_archived.html" with document=nofo user=user class_name="margin-bottom-3" only %}
  {% endif %}
{% endif %}

<div class="back-link font-body-md">
  <a class="usa-button--icon--before usa-button--arrow_back" href="{% url 'nofos:nofo_index' %}">All NOFOs</a>
</div>
<div class="nofo_edit--header nofo_edit--header--sticky" id="nofo_edit--header--id">
  {% with nofo|nofo_name as nofo_name_str %}
    <div class="nofo_edit--header--h1 {% if nofo_name_str|length > 40 %}nofo_edit--header--h1--smaller{% endif %}">
      <h1 class="font-heading- margin-0" title="{{ nofo_name_str }}">{{ nofo_name_str }}</h1>
    </div>
  {% endwith %}
  <div class="nofo_edit--header--view font-sans-xs">

    {# TODO: archived NOFOS please #}

    {# NOFO actions #}
    <div class="menu-button-links" data-disclosure>
      <button
        type="button"
        class="menu-button-links__button usa-select{% if not action_links %} usa-tooltip{% endif%}"
        aria-expanded="false"
        aria-controls="nofo-actions-{{ object.pk }}"
        id="nofo-actions-button-{{ object.pk }}"
        {% if not action_links %}
        disabled
        data-position="bottom"
        title="No actions for {{ object.status }} NOFOs"
        {% endif %}
      >
        NOFO actions
      </button>
      {% if action_links %}
        <ul id="nofo-actions-{{ object.pk }}" class="menu-button-links__list usa-sidenav" hidden>
          {% for link in action_links %}
            <li class="usa-sidenav__item">
              <a
                href="{{ link.href }}"
                class="{% if link.danger %}usa-link--destructive{% endif %}"
              >{{ link.label }}</a>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>

  </div>
</div>

{% include "includes/side_navigation.html" with side_nav_headings=side_nav_headings %}

<div class="nofo_edit--group-tag">
{% if user.group == 'bloom' %}
  <a href="{% url 'nofos:nofo_edit_group' nofo.id %}" class="usa-tag--link">
  <span class="usa-tag usa-tag--big bg-group bg-group--not-uppercase bg-group--{{ nofo.group }}">{{ nofo.get_group_display }}</span>
  </a>
{% else %}
  <span class="usa-tag usa-tag--big bg-group bg-group--not-uppercase bg-group--{{ nofo.group }}">{{ nofo.get_group_display }}</span>
{% endif %}
</div>

<div class="nofo_edit--print-buttons">
    {% include "includes/print_button.html" %}
</div>

<div class="nofo_edit--audit-widget">
  {% timezone "America/New_York" %}
    <span>
      Last updated{% if last_modified_user %} by {{ last_modified_user.full_name|default:last_modified_user.email }}{% endif %} at <strong>{{ nofo.updated|date:'F j' }} on {{ nofo.updated|date:'g:i A' }}</strong> — <a href="{% url 'nofos:nofo_history' nofo.id %}">See all updates</a>
    </span>
  {% endtimezone %}
</div>

<!-- Consolidated NOFO Status and Actions Summary Box -->
<div class="usa-summary-box margin-bottom-2" role="region" aria-labelledby="summary-box-key-information">
  <div class="usa-summary-box__body">

    {# NOFO status #}
    <h4 class="usa-summary-box__heading font-heading-sm" id="summary-box-key-information">
      <!-- Status Dropdown Form -->
      {% if not nofo.archived %}
        <form id="nofo-status--form" method="post" action="{% url 'nofos:nofo_edit_status' nofo.id %}">
          {% csrf_token %}
          <div class="usa-form-group margin-bottom-3 margin-top-0">
              <label class="usa-label display-inline-block font-sans-md margin-top-0" for="{{ status_form.status.name }}"><strong>Status:</strong></label>

            <select
              class="usa-select border-2px width-auto display-inline-block margin-top-0"
              name="{{ status_form.status.name }}"
              id="{{ status_form.status.name }}"
              onchange="this.form.submit()"
            >
              {% for value, label in status_form.status.field.choices %}
                {% if value == '' %}
                  <option disabled>{{ label }}</option>
                {% else %}
                  <option value="{{ value }}" {% if status_form.status.value == value %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </form>
      {% else %}
          NOFO is Archived.
      {% endif %}
    </h4>

    <div class="usa-summary-box__text">

      <!-- Status-specific messages and actions -->
      {% if nofo.archived %}
        <!-- ARCHIVED NOFO -->
        <p>Archived NOFOs exist as a record for posterity but can't be edited in any way. If you would like to restore this NOFO, please get in touch with Paul or Ben.</p>
        {% if nofo.successor %}
          <p>This is a past version of <a href="{% url 'nofos:nofo_edit' nofo.successor.id %}">{{ nofo.successor }}</a></p>
        {% endif %}

      {% elif nofo.status == 'cancelled' %}
        <!-- CANCELLED NOFO -->
        <div class="usa-prose">
          <span>This NOFO was <strong>cancelled</strong>. It <em>can’t</em> be edited, re-imported, or deleted.</span>
        </div>

      {% elif nofo.status == 'published' and nofo.modifications %}
        <!-- PUBLISHED WITH MODIFICATIONS -->
         <div>
          <span>This NOFO is <strong>published with modifications</strong>. It can be edited or re-imported, but <em>not</em> deleted.</span>
          <p>Make sure to update the "<a href="#modifications">Modifications</a>" section at the end of this NOFO with the changes you've made since publication.</p>
          <p><a href="{% url 'nofos:nofo_history_modifications' nofo.id %}">See changes made since this NOFO was modified</a>.</p>
          <p>Last modification date on cover page: <a href="{% url 'nofos:nofo_modifications' nofo.id %}">{{ nofo.modifications|date:"F j, Y" }}</a>.</p>
        </div>

      {% elif nofo.status == 'published' %}
        <!-- PUBLISHED (NO MODIFICATIONS) -->
        <div>
          <span>This NOFO is <strong>published</strong>. It <em>can’t</em> be edited, re-imported, or deleted.</span>
          <p class="margin-top-3">However, you can <strong>add modifications</strong> to a NOFO that has already been published.</p>
          <form id="nofo-modifications--form" method="post" action="{% url 'nofos:nofo_modifications' nofo.id %}">
            {% csrf_token %}
            <input type="hidden" name="modifications" value="{% now 'Y-m-d' %}" />
            <p>
            <button class="usa-button usa-button--accent-warm" type="submit">Add modifications</button>
            — Adds a message to the cover page and a "Modifications" section to the end of the NOFO.
            </p>
          </form>
        </div>

      {% elif nofo.status == 'review' %}
        <!-- IN REVIEW -->
        <div class="usa-prose">
          <span>This NOFO is <strong>in review</strong>. It can be edited, but <em>not</em> re-imported or deleted.</span>
        </div>


      {% elif nofo.status == 'paused' %}
        <!-- PAUSED -->
        <div class="usa-prose">
          <span>This NOFO is <strong>paused</strong>. It can be edited, but <em>not</em> re-imported or deleted.</span>
        </div>

      {% elif nofo.status == 'doge' %}
        <!-- DEP SEC (DOGE) -->
        <div class="usa-prose">
          <span>This NOFO is in <strong>Deputy Secretary review</strong>. It can be edited, but <em>not</em> re-imported or deleted.</span>
        </div>

      {% elif nofo.status == 'ready-for-qa' %}
        <!-- READY FOR QA -->
        <div class="usa-prose">
          <span>This NOFO is <strong>ready for QA</strong>. It can be edited or re-imported, but <em>not</em> deleted.</span>
        </div>

      {% elif nofo.status == 'active' %}
        <!-- ACTIVE -->
        <div class="usa-prose">
          <span>This is an <strong>active</strong> NOFO. It can be edited or re-imported, but <em>not</em> deleted.</span>
        </div>

      {% elif nofo.status == 'draft' %}
        <!-- DRAFT -->
        <div class="usa-prose">
          <span>This is a <strong>draft</strong> NOFO. It can be edited, re-imported, or deleted.</span>
        </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- tabs for broken links etc. -->

<div class="tabs">
  <h2 id="tablist-1" class="font-heading-lg margin-top-3">
    Before publishing, address the following:
  </h2>

  <div role="tablist"
       aria-labelledby="tablist-1"
       class="automatic">
    <button id="tab-1"
            type="button"
            role="tab"
            class="accent-warm-dark"
            aria-selected="true"
            aria-controls="tabpanel-1">
      <span class="focus">
        Check broken links ({{ broken_links|length }})
      </span>
    </button>
    <button id="tab-2"
            type="button"
            role="tab"
            class="secondary-darker"
            aria-selected="false"
            aria-controls="tabpanel-2"
            tabindex="-1">
      <span class="focus">
        Check heading levels ({{ heading_errors|length }})
      </span>
    </button>
  </div>
  <div id="tabpanel-1"
       role="tabpanel"
       class="accent-warm-dark"
       tabindex="0"
       aria-labelledby="tab-1">
       {% if broken_links|length %}
  <div class="usa-alert">
    <div class="usa-alert__body">
      <h3 class="usa-alert__heading">Warning: some internal links are broken</h3>
      <button class="usa-button usa-button--outline usa-button--icon usa-button--icon--before usa-button--content_copy font-sans-2xs" type="button">Copy links</button>
      <div>
        <details>
          <summary>
            {% if broken_links|length == 1 %}
            <span>There is 1 broken link</span>
            {% else %}
            <span>There are {{ broken_links|length }} broken links</span>
            {% endif %}
          </summary>
          <div>
            <ol class="usa-list usa-list--no-max-width margin-top-1">
              {% for broken_link in broken_links %}
              <li><a href="#{{ broken_link.subsection.html_id }}">{{ broken_link.link_text }}</a> ({{ broken_link.section.name }}, {{ broken_link.subsection|subsection_name_or_order }})</li>
              {% endfor %}
            </ol>
          </div>
        </details>
      </div>
    </div>
  </div>
{% endif %}

  </div>
  <div id="tabpanel-2"
       role="tabpanel"
       class="secondary-darker"
       tabindex="0"
       aria-labelledby="tab-2"
       class="is-hidden">

<!-- WARNING MESSAGE FOR HEADING ERRORS -->
{% if heading_errors|length %}
  <div class="usa-alert">
    <div class="usa-alert__body">
      <h3 class="usa-alert__heading">Warning: review headings for accessibility</h3>
      <div>
        <details>
          <summary>
            {% if heading_errors|length == 1 %}
            <span>There is 1 heading error</span>
            {% else %}
            <span>There are {{ heading_errors|length }} heading errors</span>
            {% endif %}
          </summary>
          <div>
            <ol class="usa-list usa-list--no-max-width margin-top-1">
              {% for heading_error in heading_errors %}
              <li><a href="#{{ heading_error.subsection.html_id }}">{{ heading_error.subsection|subsection_name_or_order }} ({{ heading_error.subsection.tag }})</a>: {{ heading_error.error }}</li>
              {% endfor %}
            </ol>
          </div>
        </details>
      </div>
    </div>
  </div>
{% endif %}

  </div>

  <p>
    <button class="usa-button usa-button--accent-warm" type="button">
      Check external links
    </button> — Check the links bro
  </p>
</div>

<style>
[role="tab"],
[role="tab"]:focus,
[role="tab"]:hover {
  display: inline-block;
  position: relative;
  top: 2px;
  padding: 3px 3px 4px;
  border: 1px solid hsl(219deg 1% 72%);
  border-bottom: 2px solid transparent;
  border-radius: 4px 4px 0 0;
  cursor: pointer;
}

[role="tab"][aria-selected="true"] {
  padding: 2px 2px 4px;
  border-width: 2px;
}

.accent-warm-dark[role="tab"][aria-selected="true"] {
  border-color: #9c3d10;
  background: #9c3d10;
  color: white;
}

.secondary-darker[role="tab"][aria-selected="true"] {
  border-color: #8b0a03;
  background: #8b0a03;
  color: white;
}

[role="tab"][aria-selected="false"] {
  border-bottom: transparent;
}

[role="tab"] span.focus {
  display: inline-block;
  margin: 2px;
  padding: 4px 6px;
}

[role="tabpanel"] {
  padding: 5px;
  border: 2px solid hsl(219deg 1% 72%);
  border-radius: 0 4px 4px;
}

.accent-warm-dark[role="tabpanel"] {
  border: 2px solid #9c3d10;
}

.accent-warm-dark[role="tabpanel"] .usa-button--outline {
  box-shadow: inset 0 0 0 2px #9c3d10;
  color: #9c3d10;
}

.nofo_edit .usa-alert__body .usa-button--content_copy::before {
filter: brightness(0) saturate(100%) invert(20%) sepia(86%) saturate(1996%) hue-rotate(8deg) brightness(93%) contrast(87%);
}

.nofo_edit .usa-alert__body details > summary > span {
  text-decoration: underline;
}

.secondary-darker[role="tabpanel"] {
  border: 2px solid #8b0a03;
}

[role="tabpanel"] .usa-site-alert--emergency .usa-alert .usa-alert__body {
  color: #1b1b1b;
  background: white;
}

[role="tabpanel"] .usa-alert {
  background: white;
  border-left: none;
}

[role="tabpanel"].is-hidden {
  display: none;
}
</style>
<script>
  /*
 *   This content is licensed according to the W3C Software License at
 *   https://www.w3.org/Consortium/Legal/2015/copyright-software-and-document
 *
 *   File:   tabs-automatic.js
 *
 *   Desc:   Tablist widget that implements ARIA Authoring Practices
 */

'use strict';

class TabsAutomatic {
  constructor(groupNode) {
    this.tablistNode = groupNode;

    this.tabs = [];

    this.firstTab = null;
    this.lastTab = null;

    this.tabs = Array.from(this.tablistNode.querySelectorAll('[role=tab]'));
    this.tabpanels = [];

    for (var i = 0; i < this.tabs.length; i += 1) {
      var tab = this.tabs[i];
      var tabpanel = document.getElementById(tab.getAttribute('aria-controls'));

      tab.tabIndex = -1;
      tab.setAttribute('aria-selected', 'false');
      this.tabpanels.push(tabpanel);

      tab.addEventListener('keydown', this.onKeydown.bind(this));
      tab.addEventListener('click', this.onClick.bind(this));

      if (!this.firstTab) {
        this.firstTab = tab;
      }
      this.lastTab = tab;
    }

    this.setSelectedTab(this.firstTab, false);
  }

  setSelectedTab(currentTab, setFocus) {
    if (typeof setFocus !== 'boolean') {
      setFocus = true;
    }
    for (var i = 0; i < this.tabs.length; i += 1) {
      var tab = this.tabs[i];
      if (currentTab === tab) {
        tab.setAttribute('aria-selected', 'true');
        tab.removeAttribute('tabindex');
        this.tabpanels[i].classList.remove('is-hidden');
        if (setFocus) {
          tab.focus();
        }
      } else {
        tab.setAttribute('aria-selected', 'false');
        tab.tabIndex = -1;
        this.tabpanels[i].classList.add('is-hidden');
      }
    }
  }

  setSelectedToPreviousTab(currentTab) {
    var index;

    if (currentTab === this.firstTab) {
      this.setSelectedTab(this.lastTab);
    } else {
      index = this.tabs.indexOf(currentTab);
      this.setSelectedTab(this.tabs[index - 1]);
    }
  }

  setSelectedToNextTab(currentTab) {
    var index;

    if (currentTab === this.lastTab) {
      this.setSelectedTab(this.firstTab);
    } else {
      index = this.tabs.indexOf(currentTab);
      this.setSelectedTab(this.tabs[index + 1]);
    }
  }

  /* EVENT HANDLERS */

  onKeydown(event) {
    var tgt = event.currentTarget,
      flag = false;

    switch (event.key) {
      case 'ArrowLeft':
        this.setSelectedToPreviousTab(tgt);
        flag = true;
        break;

      case 'ArrowRight':
        this.setSelectedToNextTab(tgt);
        flag = true;
        break;

      case 'Home':
        this.setSelectedTab(this.firstTab);
        flag = true;
        break;

      case 'End':
        this.setSelectedTab(this.lastTab);
        flag = true;
        break;

      default:
        break;
    }

    if (flag) {
      event.stopPropagation();
      event.preventDefault();
    }
  }

  onClick(event) {
    this.setSelectedTab(event.currentTarget);
  }
}

// Initialize tablist

window.addEventListener('load', function () {
  var tablists = document.querySelectorAll('[role=tablist].automatic');
  for (var i = 0; i < tablists.length; i++) {
    new TabsAutomatic(tablists[i]);
  }
});
</script>

<table class="usa-table usa-table--borderless width-full table--hide-edit-if-published table--hide-edit-if-archived">
  <caption>
    <div>
      <h2 class="margin-bottom-0">Basic information</h2>
    </div>
  </caption>
  <thead class="usa-sr-only">
    <tr>
      <th scope="col">Key</th>
      <th scope="col">Value</th>
      <th scope="col">Manage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th scope="row">Title</th>
      <td>{{ nofo.title }}</td>
      <td><a href="{% url 'nofos:nofo_edit_title' nofo.id %}">Edit<span class="usa-sr-only"> title</span></a></td>
    </tr>
    <tr>
      <th scope="row">Short&nbsp;name</th>
      <td>{{ nofo.short_name|get_value_or_none:"short name" }}</td>
      <td><a href="{% url 'nofos:nofo_edit_short_name' nofo.id %}">Edit<span class="usa-sr-only"> short name</span></a></td>
    </tr>
    <tr>
      <th scope="row">Number</th>
      <td>{{ nofo.number|get_value_or_none:"number" }}</td>
      <td><a href="{% url 'nofos:nofo_edit_number' nofo.id %}">Edit<span class="usa-sr-only"> number</span></a></td>
    </tr>
    <tr>
      <th scope="row">Application deadline</th>
      <td>{{ nofo.application_deadline|get_value_or_none:"application deadline" }}</td>
      <td><a href="{% url 'nofos:nofo_edit_application_deadline' nofo.id %}">Edit<span class="usa-sr-only"> application
            deadline</span></a></td>
    </tr>
    <tr>
      <th scope="row">OpDiv</th>
      <td>{{ nofo.opdiv|get_value_or_none:"OpDiv" }}</td>
      <td><a href="{% url 'nofos:nofo_edit_opdiv' nofo.id %}">Edit<span class="usa-sr-only"> OpDiv</span></a></td>
    </tr>
    <tr>
      <th scope="row">Agency</th>
      <td>{{ nofo.agency|get_value_or_none:"agency" }}</td>
      <td><a href="{% url 'nofos:nofo_edit_agency' nofo.id %}">Edit<span class="usa-sr-only"> Agency</span></a></td>
    </tr>
    <tr>
      <th scope="row">Subagency</th>
      <td>{{ nofo.subagency|get_value_or_none:"subagency" }}</td>
      <td><a href="{% url 'nofos:nofo_edit_subagency' nofo.id %}">Edit<span class="usa-sr-only"> Subagency</span></a>
      </td>
    </tr>
    <tr>
      <th scope="row">Subagency 2</th>
      <td>{{ nofo.subagency2|get_value_or_none:"subagency 2" }}</td>
      <td><a href="{% url 'nofos:nofo_edit_subagency2' nofo.id %}">Edit<span class="usa-sr-only"> Subagency 2</span></a>
      </td>
    </tr>
    <tr>
      <th scope="row">Tagline</th>
      <td>{{ nofo.tagline|get_value_or_none:"tagline"|safe_markdown }}</td>
      <td><a href="{% url 'nofos:nofo_edit_tagline' nofo.id %}">Edit<span class="usa-sr-only"> theme</span></a></td>
    </tr>
    {% if nofo.modifications %}
      <tr>
        <th scope="row">Modification date</th>
        <td class="nofo-modifications-message">
          “Last modified {{ nofo.modifications|date:"F j, Y" }}. <a class="text-base" href="#modifications">Review updates</a>.”
        </td>
        <td><a href="{% url 'nofos:nofo_modifications' nofo.id %}">Edit<span class="usa-sr-only"> modification date</span></a></td>
      </tr>
    {% endif %}
  </tbody>
</table>

<table class="usa-table usa-table--borderless width-full table--hide-edit-if-archived">
  <caption>
    <div>
      <h2 class="margin-bottom-0">NOFO metadata</h2>
      <span class="padding-right-2 font-sans-sm">
        <a href="{% url 'nofos:nofo_edit_metadata' nofo.id %}">Edit<span class="usa-sr-only"> metadata: NOFO theme, cover style, and icon style</span></a>
      </span>
    </div>
  </caption>
  <thead class="usa-sr-only">
    <tr>
      <th scope="col">Key</th>
      <th scope="col">Value</th>
    </tr>
  </thead>
  <tbody class="no-edit-link">
    <tr>
      <th scope="row">Author</th>
      <td>{{ nofo.author|get_value_or_none:"author" }}</td>
    </tr>
    <tr>
      <th scope="row">Subject</th>
      <td>{{ nofo.subject|get_value_or_none:"subject" }}</td>
    </tr>
    <tr>
      <th scope="row">Keywords</th>
      <td>{{ nofo.keywords|get_value_or_none:"keywords" }}</td>
    </tr>
  </tbody>
</table>

<table class="usa-table usa-table--borderless width-full table--hide-edit-if-archived">
  <caption>
    <div>
      <h2 class="margin-bottom-0">NOFO theme options</h2>
      <span class="padding-right-2 font-sans-sm">
        <a href="{% url 'nofos:nofo_edit_theme_options' nofo.id %}">Edit<span class="usa-sr-only">: NOFO theme, cover style, and icon style</span></a>
      </span>
    </div>
  </caption>
  <thead class="usa-sr-only">
    <tr>
      <th scope="col">Key</th>
      <th scope="col">Value</th>
    </tr>
  </thead>
  <tbody class="no-edit-link">
    <tr>
      <th scope="row">Theme</th>
      <td>{{ nofo.get_theme_display|get_value_or_none:"theme" }}</td>
    </tr>
    <tr>
      <th scope="row">Cover style</th>
      <td>{{ nofo.get_cover_display|get_value_or_none:"Standard image" }}</td>
    </tr>
    <tr>
      <th scope="row">Icon style</th>
      <td>{{ nofo.get_icon_style_display|get_value_or_none:"Outlined" }}</td>
    </tr>
  </tbody>
</table>

<table class="usa-table usa-table--borderless width-full table--hide-edit-if-archived">
  <caption>
    <div>
      <h2 class="margin-bottom-0">NOFO cover image</h2>
      <span class="padding-right-2 font-sans-sm">
        {% if nofo.cover_image %}
          <a href="{% url 'nofos:nofo_edit_cover_image' nofo.id %}">Edit<span class="usa-sr-only">: NOFO cover image</span></a>
        {% else %}
          <a href="{% url 'nofos:nofo_upload_cover_image' nofo.id %}">Edit<span class="usa-sr-only">: NOFO cover image</span></a>
        {% endif %}
      </span>
    </div>
  </caption>
  <thead class="usa-sr-only">
    <tr>
      <th scope="col">Key</th>
      <th scope="col">Value</th>
    </tr>
  </thead>
  <tbody class="no-edit-link">
    <tr>
      <th scope="row">Cover image</th>
      <td>{{ nofo.cover_image|get_value_or_none:"cover image" }}</td>
    </tr>
    {% if nofo.cover_image %}
    <tr>
      <th scope="row">Cover alt text</th>
      <td>{{ nofo.cover_image_alt_text|get_value_or_none:"cover alt text" }}</td>
    </tr>
    {% endif %}
  </tbody>
</table>

<table class="usa-table usa-table--borderless width-full table--hide-edit-if-archived">
  <caption>
    <div>
      <h2 class="margin-bottom-0">NOFO coach and designer</h2>
      <span class="padding-right-2 font-sans-sm">
        <a href="{% url 'nofos:nofo_edit_coach_designer' nofo.id %}">Edit<span class="usa-sr-only">: NOFO theme, cover style, and icon style</span></a>
      </span>
    </div>
  </caption>
  <thead class="usa-sr-only">
    <tr>
      <th scope="col">Key</th>
      <th scope="col">Value</th>
    </tr>
  </thead>
  <tbody class="no-edit-link">
    <tr>
      <th scope="row">Coach name</th>
      <td>{{ nofo.get_coach_display|get_value_or_none:"coach" }}</td>
    </tr>
    <tr>
      <th scope="row">Designer name</th>
      <td>{{ nofo.get_designer_display|get_value_or_none:"designer" }}</td>
    </tr>
  </tbody>
</table>

{% if 'camille.c' in user.email or user.is_superuser %}
  <table class="usa-table usa-table--borderless width-full table--hide-edit-if-published table--hide-edit-if-archived">
    <caption>
      <div>
        <h2 class="margin-bottom-0">NOFO Before You Begin page</h2>
      </div>
    </caption>
    <thead class="usa-sr-only">
      <tr>
        <th scope="col">Key</th>
        <th scope="col">Value</th>
        <th scope="col">Manage</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th scope="row">BYB page setting</th>
        <td>{{ nofo.get_before_you_begin_display|get_value_or_none:"setting selected" }}</td>
        <td><a href="{% url 'nofos:nofo_edit_byb' nofo.id %}">Edit<span class="usa-sr-only"> Before you being page</span></a></td>
      </tr>
    </tbody>
  </table>
{% endif %}

<div id="back-to-top--sentinel" aria-hidden="true"></div>

{% for section in nofo.sections.all|dictsort:"order" %}
<table class="usa-table usa-table--borderless width-full table--hide-edit-if-published table--hide-edit-if-archived table--section">
  <caption aria-label="{{ section.name|strip_br }}">
    <div>
      <h2 class="margin-bottom-0" id="{{ section.html_id }}">{{ section.name|safe_br }}</h2>
      <span class="section--copy-button">
        <button
          type="button"
          class="usa-button usa-button--unstyled usa-tooltip usa-button--icon--after usa-button--icon--only usa-button--content_copy"
          data-position="bottom"
          data-section-id="{{ section.html_id }}"
          title="Copy link to this section"
        >
          <span class="usa-sr-only">Copy link to this section</span>
        </button>
      </span>

      {% if "section--tables-full-width" in section.html_class %}
        <span class="usa-tooltip" data-position="bottom" title="This section contains full-width tables" aria-label="Full-width tables">↔️</span>
      {% endif %}

      <span class="add-or-remove-subsections"><a href="{% url 'nofos:section_detail' nofo.id section.id %}">Configure section</a></span>
    </div>
  </caption>
  <thead class="usa-sr-only">
    <tr>
      <th scope="col">Heading</th>
      <th scope="col">Heading link</th>
      <th scope="col">Heading level</th>
      <th scope="col">Is callout box</th>
      <th scope="col">Content</th>
      <th scope="col">Manage</th>
    </tr>
  </thead>
  <tbody>
    {% for subsection in section.subsections.all|dictsort:"order" %}
    {# Ignore "Basic information" subsection #}
      {% if subsection.name != "Basic information" %}
        <tr>
          <th scope="row"
            class="nofo-edit-table--subsection--name{% if subsection|has_heading_error:heading_errors %} nofo_edit--heading-error{% endif %}{% if subsection.html_class %} {{ subsection.html_class }}{% endif %}"
            id="{{ subsection.html_id }}">
            <span class="floating">
              {% if subsection.name %}
                <span {% if subsection|has_heading_error:heading_errors %}class="usa-tooltip" data-position="bottom" title="{{ subsection|get_heading_error:heading_errors|split_char_and_remove:":" }}."{% endif %}>
                  {{ subsection.name|safe_br }}
                </span>
              {% else %}
                <span class="text-base">(#{{ subsection.order}})</span>
              {% endif %}
            </span>
          </th>
          <td class="nofo-edit-table--subsection--copy-button">
            <span class="subsection--copy-button floating">
              <button
                type="button"
                class="usa-button usa-button--unstyled usa-tooltip usa-button--icon--after usa-button--icon--only usa-button--content_copy"
                data-position="bottom"
                data-section-id="{{ subsection.html_id }}"
                title="Copy link to this heading"
              >
                <span class="usa-sr-only">Copy link to this heading</span>
              </button>
            </span>
          </td>
          <td class="nofo-edit-table--subsection--heading-level">
            {% if subsection.tag %}
              <span class="floating small-caps">
                {{ subsection.tag|upper }}
              </span>
            {% endif %}
          </td>
          <td class="nofo-edit-table--subsection--callout-box">
            {% if subsection.callout_box %}
              <span class="floating">
                <span role="img" aria-label="Callout box" title="This subsection is a callout box" class="usa-tooltip" data-position="bottom">📦</span>
              </span>
            {% endif %}
          </td>
          <td class="nofo-edit-table--subsection--body">
            {{ subsection.body|safe_markdown|add_classes_to_tables|convert_paragraphs_to_hrs|add_classes_to_broken_links:broken_links|get_value_or_none:"content" }}
          </td>
          <td class="nofo-edit-table--subsection--manage">
            <span class="floating">
              <a href="{% url 'nofos:subsection_edit' nofo.id section.id subsection.id %}">Edit<span class="usa-sr-only"> subsection: {{ subsection.name|strip_br }}</span></a>
            </span>
          </td>
        </tr>
      {% endif %}
    {% endfor %}
  </tbody>
</table>
{% endfor %}

<div class="back-to-top--container">
  <a class="back-to-top usa-button--icon usa-button--icon--before usa-button--arrow_upward" href="#back-to-top">Top</a>
</div>
{% endblock %}
