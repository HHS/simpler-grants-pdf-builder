{% extends 'base.html' %}
{% load static martortags add_classes_to_tables add_footnote_ids add_captions_to_tables add_classes_to_lists add_classes_to_paragraphs convert_paragraphs_to_hrs %}

{% block title %}
  Content Guide comparison result
{% endblock %}

{% block css %}
  <link href="{% static "styles-theme-base.css" %}" type="text/css" media="all" rel="stylesheet">
  <link href="{% static "theme-orientation-portrait.css" %}" type="text/css" media="all" rel="stylesheet">
  <link href="{% static "theme-opdiv-cdc.css" %}" type="text/css" media="all" rel="stylesheet">
  <link href="{% static "theme-opdiv-cdc-blue.css" %}" type="text/css" media="all" rel="stylesheet">
{% endblock %}

{% block body_class %}nofo_compare nofo_compare--content-guide{% if not comparison %} nofo_compare--content-guide--comparison{% endif %}{% endblock %}

{% block content %}
  <div class="usa-alert usa-alert--warning usa-alert--slim usa-alert--no-icon usa-alert--alpha margin-bottom-3">
    <div class="usa-alert__body bg-base-lightest">
      <p class="usa-alert__text">
        <span class="usa-tag bg-gold text-ink">Beta</span>
        <span class="margin-left-1">Comparing a Content Guide to a NOFO is an experimental feature and will change as we improve it. <br />{% include "includes/feedback_link.html" %}.</span>
      </p>
    </div>
  </div>

  {% url 'guides:guide_edit' guide.id as back_href %}
  {% include "includes/page_heading.html" with title="Check out the differences" back_text="Compare a NOFO to Content Guide “"|add:guide.title|add:"”" back_href=back_href only %}

  <div class="usa-prose margin-bottom-5">
    <p>Get a breakdown of what content has changed between the current version and{% if not num_changed_subsections %} another one that you upload{% else %} your newly uploaded one{% endif %}.</p>

    <p class="font-sans-lg"><strong>Compare overview</strong></p>
    <ul>
      {% if not num_changed_subsections %}
      {% elif num_changed_subsections == 0 %}
        <li>There are <strong>no changes</strong> in this new document.</li>
      {% else %}
        <li>There are <strong>{{ num_changed_subsections }}</strong> section{{ num_changed_subsections|pluralize }} with changes.</li>
      {% endif %}
      <li><del>Red with a strikethrough</del> is a deletion</li>
      <li><ins>Green with an underline</ins> is an addition</li>
    </ul>

    <a class="usa-button" href="{% url 'guides:guide_edit' guide.pk %}">Set up compare settings</a>
  </div>
  
  {% if comparison %}
    <details class="margin-bottom-5">
      <summary>
        <span class="font-sans-lg"><strong>Sections with changes</strong></span>
      </summary>

      <ul>
        {% for section in comparison %}
        <p>Section: {{ section.name }}</a></p>
          {% for subsection in section.subsections %}
            <li>
              {% if subsection.status != 'MATCH' %}<strong>{% endif %}
                <a href="#{{ subsection.html_id }}">{{ subsection.name }}</a>: {{ subsection.status }}
              {% if subsection.status != 'MATCH' %}</strong>{% endif %}
            </li>
          {% endfor %}
        {% endfor %}
      </ul>
    </details>
  {% endif %}

  {% if num_changed_subsections == 0 %}
  <div class="usa-alert usa-alert--info usa-alert--slim margin-bottom-5">
    <div class="usa-alert__body">
      <p class="usa-alert__text">
        <strong>No changes</strong>: This document (<span class="font-mono-sm">{{ new_nofo.filename }}</span>) matches your Content Guide: “{{ guide.title }}”.
      </p>
    </div>
  </div>
  {% endif %}

    <div class="nofo_view--wrapper">
      <div class="nofo_view--menu-bar">
        {% with current_view=request.path %}
          <a
            href="{{ current_view }}?display=double"
            class="nofo_view--menu-bar--button nofo_view--menu-bar--button__content_copy{% if display_mode == 'single' %} is-disabled{% else %} is-active{% endif %}"
            {% if display_mode == "single" %}aria-disabled="true"{% endif %}
          >
            Side-by-side view
          </a>
          <a
            href="{{ current_view }}?display=single"
            class="nofo_view--menu-bar--button nofo_view--menu-bar--button__upload_file{% if display_mode == 'double' %} is-disabled{% else %} is-active{% endif %}"
            {% if display_mode == "double" %}aria-disabled="true"{% endif %}
          >
            Single view
          </a>
        {% endwith %}
        <div class="nofo_view--menu-bar--vertical-space"></div>
        <button class="nofo_view--menu-bar--button nofo_view--menu-bar--button__expand_less">
          Previous section
        </button>
        <button class="nofo_view--menu-bar--button nofo_view--menu-bar--button__expand_more">
          Next section
        </button>
      </div>
      <div class="nofo_view--title-bar">
        {% if display_mode == 'double' %}
          <div class="nofo_view--title-old">
            <h2 class="margin-0">{{ guide.title }}</h2>
          </div>
          <div class="nofo_view--title-new">
            {% if comparison %}
              <h2 class="margin-0">[Agency] NOFO</h2>
            {% endif %}
          </div>
        {% else %}
          <div class="nofo_view--title-old">
            <h2 class="margin-0">{{ guide.title }} + [Agency] NOFO</h2>
          </div>
        {% endif %}
      </div>
      <div class="nofo_view">
        {% if display_mode == 'double' %}
          {% if comparison %}
            <div class="nofo_view--old">
              {% for section in comparison %}
                <section id="section--{{ section.html_id }}" class="section section--{{ forloop.counter }} {% if forloop.counter > 7 %}section--appendix {% endif %}section--{{ section.html_id }}{% if section.html_class %} {{ section.html_class }}{% endif %}">
                  <h2 id="{{ section.html_id }}" >{{ section.name }}</h2>
                  <div class="section--content">
                    {% for subsection in section.subsections %}
                      {% if subsection.status == 'MATCH' or subsection.status == 'DELETE' or subsection.status == 'UPDATE' %}
                        {% with tag=subsection.tag content=subsection.name id=subsection.html_id class=subsection.html_class %}
                            {% include "includes/heading.html" with tag=tag content=content id=id class=class only %}
                        {% endwith %}
                        {% if subsection.old_diff %}
                          {{ subsection.old_diff|safe|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
                        {% elif subsection.old_value %}
                          {{ subsection.old_value|safe_markdown|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  </div>
                </section>
              {% endfor %}
            </div>
            <div class="nofo_view--new">
              {% for section in comparison %}
                <section id="section--{{ section.html_id }}" class="section section--{{ forloop.counter }} {% if forloop.counter > 7 %}section--appendix {% endif %}section--{{ section.html_id }}{% if section.html_class %} {{ section.html_class }}{% endif %}">
                  <h2 id="{{ section.html_id }}" >{{ section.name }}</h2>
                  <div class="section--content">
                    {% for subsection in section.subsections %}
                      {% if subsection.status == 'MATCH' or subsection.status == 'ADD' or subsection.status == 'UPDATE' %}
                        {% with tag=subsection.tag content=subsection.name id=subsection.html_id class=subsection.html_class %}
                            {% include "includes/heading.html" with tag=tag content=content id=id class=class only %}
                        {% endwith %}
                          {% if subsection.new_diff %}
                            {{ subsection.new_diff|safe|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
                          {% elif subsection.new_value %}
                            {{ subsection.new_value|safe_markdown|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
                          {% endif %}
                      {% endif %}
                    {% endfor %}
                  </div>
                </section>
              {% endfor %}
            </div>
          {% else %}
          {# comparison does not exist, show original guide and column with upload button #}
            <div class="nofo_view--old">
              {% for section in guide.sections.all|dictsort:"order" %}
                <section id="section--{{ section.html_id }}" class="section section--{{ forloop.counter }} {% if forloop.counter > 7 %}section--appendix {% endif %}section--{{ section.html_id }}{% if section.html_class %} {{ section.html_class }}{% endif %}">
                  <h2 id="{{ section.html_id }}" >{{ section.name }}</h2>
                  <div class="section--content">
                    {% for subsection in section.subsections.all|dictsort:"order" %}
                      {% with tag=subsection.tag content=subsection.name id=subsection.html_id class=subsection.html_class %}
                          {% include "includes/heading.html" with tag=tag content=content id=id class=class only %}
                      {% endwith %}
                      {{ subsection.body|safe_markdown|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
                    {% endfor %}
                  </div>
                </section>
              {% endfor %}
            </div>
            <div class="nofo_view--new nofo_view--new--empty">
              <p class="margin-top-6">Ready to compare to this content guide?</p>
              <p>Upload a NOFO to see it here.</p>
              <p class="margin-top-2"><a class="usa-button" href="{% url 'guides:guide_compare_upload' guide.pk %}">Upload a NOFO to compare</a></p>
            </div>
          {% endif %}
        </div>
        {% else %}
        {# display_mode="single": Show consolidated view #}
          <div class="nofo_view--old">
            {% for section in comparison %}
              <section id="section--{{ section.html_id }}" class="section section--{{ forloop.counter }} {% if forloop.counter > 7 %}section--appendix {% endif %}section--{{ section.html_id }}{% if section.html_class %} {{ section.html_class }}{% endif %}">
                <h2 id="{{ section.html_id }}" >{{ section.name }}</h2>
                <div class="section--content">
                  {% for subsection in section.subsections %}
                      {% with tag=subsection.tag content=subsection.name id=subsection.html_id class=subsection.html_class %}
                          {% include "includes/heading.html" with tag=tag content=content id=id class=class only %}
                      {% endwith %}
                      {% if subsection.diff %}
                        {{ subsection.diff|safe|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
                      {% elif subsection.old_value %}
                        {{ subsection.old_value|safe_markdown|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
                      {% elif subsection.new_value %}
                        {{ subsection.new_value|safe_markdown|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
                      {% endif %}
                  {% endfor %}
                </div>
              </section>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
{% endblock %}
