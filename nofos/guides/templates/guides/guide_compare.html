{% extends 'base.html' %}
{% load static martortags add_classes_to_tables add_footnote_ids add_captions_to_tables add_classes_to_lists add_classes_to_paragraphs convert_paragraphs_to_hrs safe_br %}

{% block title %}
  Content Guide comparison result
{% endblock %}

{% block css %}
  <link href="{% static "styles-theme-base.css" %}" type="text/css" media="all" rel="stylesheet">
  <link href="{% static "theme-orientation-portrait.css" %}" type="text/css" media="all" rel="stylesheet">
  <link href="{% static "theme-opdiv-cdc.css" %}" type="text/css" media="all" rel="stylesheet">
  <link href="{% static "theme-opdiv-cdc-blue.css" %}" type="text/css" media="all" rel="stylesheet">
{% endblock %}

{% block body_class %}nofo_compare nofo_compare--content-guide{% if comparison %} nofo_compare--content-guide--comparison{% endif %}{% if display_mode == 'single' %} nofo_compare--content-guide--display-single{% else %} nofo_compare--content-guide--display-double{% endif %}{% endblock %}

{% block content %}
  {% url 'guides:guide_edit' guide.id as back_href %}
  {% include "includes/page_heading.html" with title="Review the differences" back_text=guide.title back_href=back_href only %}

  <div class="usa-prose margin-bottom-1">
    <p>
      Your content guide is displayed here.
      When you upload a NOFO to compare, it'll be displayed next to the content guide and list places where the NOFO’s boilerplate does not match the content guide.
    </p>
  </div>

  <ul class="usa-button-group">
    <li class="usa-button-group__item margin-right-2">
      <a class="usa-button" href="{% url 'guides:guide_compare_upload' guide.pk %}">Upload a NOFO to compare</a>
    </li>
    <li class="usa-button-group__item">
      <a class="usa-button usa-button--outline" href="{% url 'guides:guide_edit' guide.pk %}{% if new_nofo %}?new_nofo={{ new_nofo.id }}{% endif %}">Choose sections to compare</a>
    </li>
  </ul>

  <div class="usa-accordion--bordered margin-top-4 margin-bottom-4" data-allow-multiple>
    <h4 class="usa-accordion__heading">
      <button class="usa-accordion__button"
              aria-expanded="true"
              aria-controls="guide-differences">
        Guide to differences
      </button>
    </h4>
    <div id="guide-differences" class="usa-accordion__content usa-prose">
      <ul>
        <li><del>Red with a strikethrough</del> is a deletion</li>
        <li><ins>Green with an underline</ins> is content that has been added</li>
        <li><strong>Side-by-side view</strong> shows both the content guide and NOFO next to each other highlighting the differences across both documents</li>
        <li><strong>Single view</strong> shows the content guide with all the boilerplate differences between the NOFO and the content guide marked</li>
      </ul>
    </div>
  </div>

  {% if num_changed_subsections == 0 %}
  <div class="usa-alert usa-alert--info usa-alert--slim margin-bottom-5">
    <div class="usa-alert__body">
      <p class="usa-alert__text">
        <strong>No changes</strong>: This document (<span class="font-mono-sm">{{ new_nofo.filename }}</span>) matches your Content Guide: “{{ guide.title }}”.
      </p>
    </div>
  </div>
  {% endif %}

    <div id="nofo_view--wrapper" class="nofo_view--wrapper">
      <div class="nofo_view--menu-bar">
        {% with current_view=request.path %}
          <a
            href="{{ current_view }}?display=double"
            class="nofo_view--menu-bar--button nofo_view--menu-bar--button__content_copy{% if display_mode == 'double' %} is-active{% endif %}"
          >
            Side-by-side view
          </a>
          <a
            href="{{ current_view }}?display=single"
            class="nofo_view--menu-bar--button nofo_view--menu-bar--button__upload_file{% if display_mode == 'single' %} is-active{% endif %}"
            {% if not comparison %}aria-disabled="true"{% endif %}
          >
            Single view
          </a>
        {% endwith %}
        <div class="nofo_view--vertical-divider"></div>
        <button class="nofo_view--menu-bar--button nofo_view--menu-bar--button__expand_less" {% if not comparison %}aria-disabled="true"{% endif %} type="button">
          Previous section
        </button>
        <button class="nofo_view--menu-bar--button nofo_view--menu-bar--button__expand_more" {% if not comparison %}aria-disabled="true"{% endif %} type="button">
          Next section
        </button>

          <div class="nofo_view--menu-bar--file-download-button--container">
            {% if comparison %}
              <a class="usa-button usa-button--outline usa-button--icon usa-button--file-download" type="button"
                href="{% url 'guides:guide_compare_result_csv' pk=guide.pk new_nofo_id=new_nofo.pk %}">
                <span class="margin-left-2">Export spreadsheet of differences</span>
              </a>
            {% else %}
              <a class="usa-button usa-button--icon usa-button--file-download" aria-disabled="true">
                <span class="margin-left-2">Export spreadsheet of differences</span>
              </a>
            {% endif %}
          </div>
      </div>
      <div class="nofo_view--title-bar">
        {% if display_mode == 'double' %}
          <div class="nofo_view--title--table-container">
            <table>
              <tr>
                <td>
                  <h2 class="margin-0">{{ guide.title }}</h2>
                </td>
                {% if comparison %}
                  <td>
                    <h2 class="margin-0">{{ new_nofo.filename }}</h2>
                  </td>
                {% endif %}
              </tr>
            </table>
          </div>
        {% else %}
          <div class="nofo_view--title--table-container">
            <table>
              <tr>
                <td>
                  <h2 class="margin-0">{{ guide.title }} + {{ new_nofo.filename }}</h2>
                </td>
              </tr>
            </table>
          </div>
        {% endif %}
        <div class="nofo_view--vertical-divider mr-0"></div>
        <div class="nofo_view--title-changes">
          <h2 class="margin-0">All differences</h2>
        </div>
      </div>
      <div id="nofo_view" class="nofo_view">
        {% if display_mode == 'double' %}
          {% if comparison %}
            <div class="nofo_view--table-container">
              {% for section in comparison %}
                <table id="section--{{ section.html_id }}" class="section section--{{ forloop.counter }} {% if forloop.counter > 7 %}section--appendix {% endif %}section--{{ section.html_id }}{% if section.html_class %} {{ section.html_class }}{% endif %}">
                  <tr class="section--content">
                    <td>
                      {# Note: this code presumes we always have the same number of sections #}
                      <h2 id="{{ section.html_id }}" >{{ section.name }}</h2>
                    </td>
                    <td>
                      <h2 id="{{ section.html_id }}" >{{ section.name }}</h2>
                    </td>
                  </tr>
                  {% for subsection in section.subsections %}
                    <tr class="section--content">
                      {% if subsection.status == 'MATCH' or subsection.status == 'DELETE' or subsection.status == 'UPDATE' %}
                        {% with tag=subsection.tag content=subsection.name id=subsection.html_id class=subsection.html_class %}
                          <td>
                            {% if subsection.status == 'DELETE' %}<del>{% endif %}
                              {% include "includes/heading.html" with tag=tag content=content id=id class=class only %}
                            {% if subsection.status == 'DELETE' %}</del>{% endif %}
                          </td>
                        {% endwith %}
                      {% else %}
                          <td></td>
                      {% endif %}
                      {% if subsection.status == 'MATCH' or subsection.status == 'ADD' or subsection.status == 'UPDATE' %}
                        {% with tag=subsection.tag content=subsection.name id=subsection.html_id class=subsection.html_class %}
                          <td>
                            {% if subsection.status == 'ADD' %}<ins>{% endif %}
                              {% include "includes/heading.html" with tag=tag content=content id=id class=class only %}
                            {% if subsection.status == 'ADD' %}</ins>{% endif %}
                          </td>
                        {% endwith %}
                      {% else %}
                        <td></td>
                      {% endif %}
                    </tr>
                    <tr class="section--content" {% if not subsection.tag %}id="{{ subsection.html_id }}"{% endif %}>
                      {# old diff cell #}
                      {% if subsection.status == 'MATCH' or subsection.status == 'DELETE' or subsection.status == 'UPDATE' %}
                        {% if subsection.old_diff %}
                          <td>{{ subsection.old_diff|safe|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}</td>
                        {% elif subsection.old_value %}
                          <td>{{ subsection.old_value|safe_markdown|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}</td>
                        {% endif %}
                      {% else %}
                        <td></td>
                      {% endif %}

                      {# new diff cell #}
                      {% if subsection.status == 'MATCH' or subsection.status == 'ADD' or subsection.status == 'UPDATE' %}
                          {% if subsection.new_diff %}
                            <td>{{ subsection.new_diff|safe|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}</td>
                          {% elif subsection.new_value %}
                            <td>{{ subsection.new_value|safe_markdown|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}</td>
                          {% endif %}
                      {% else %}
                        <td></td>
                      {% endif %}
                    </tr>
                    {% endfor %}
                  </table>
              {% endfor %}
              </div>
            <div class="nofo_view--vertical-divider mr-0"></div>
            <div class="nofo_view--changes">
              <div class="usa-alert usa-alert--info usa-alert--no-icon  margin-bottom-2">
                <div class="usa-alert__body">
                  <p class="usa-alert__text">
                    {% if num_changed_subsections == 0 %}
                      Your NOFO has no changes.
                    {% elif num_changed_subsections == 1 %}
                      Your NOFO has changes in 1 section.
                    {% else %}
                      Your NOFO has changes in {{ num_changed_subsections }} sections.
                    {% endif %}
                  </p>
                </div>
              </div>
              <div class="nofo_view--changes--list">
                <ol>
                  {% for changed_subsection in changed_subsections %}
                    <li>
                      <a href="#{{ changed_subsection.html_id }}">{{ forloop.counter }}. {{ changed_subsection.name|strip_br_ins_del }}<br />{{ changed_subsection.status }}</a>
                    </li>
                  {% endfor %}
                </ol>
              </div>
            </div>
          {% else %}
          {# comparison does not exist, show original guide and grey column #}
            <div class="nofo_view--table-container nofo_view--table-container--no-comparison">
              {% for section in guide.sections.all|dictsort:"order" %}
                <table id="section--{{ section.html_id }}" class="section section--{{ forloop.counter }} {% if forloop.counter > 7 %}section--appendix {% endif %}section--{{ section.html_id }}{% if section.html_class %} {{ section.html_class }}{% endif %}">
                  <tr class="section--content">
                    <td>
                      <h2 id="{{ section.html_id }}" >{{ section.name }}</h2>
                    </td>
                    {% for subsection in section.subsections.all|dictsort:"order" %}
                      <tr class="section--content">
                      {% with tag=subsection.tag content=subsection.name id=subsection.html_id class=subsection.html_class %}
                        <td>{% include "includes/heading.html" with tag=tag content=content id=id class=class only %}</td>
                      {% endwith %}
                      </tr>
                      <tr class="section--content">
                        <td>{{ subsection.body|safe_markdown|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}</td>
                      </tr>
                    {% endfor %}
                  </tr>
                </table>
              {% endfor %}
            </div>
            <div class="nofo_view--table-container nofo_view--table-container--empty">
              <div class="guide_compare_upload">
                <p class="margin-left-4 margin-right-4 margin-top-6 font-sans-md">Upload a NOFO to compare it to this content guide.</p>
              </div>
            </div>
            <div class="nofo_view--vertical-divider mr-0"></div>
            <div class="nofo_view--changes">
              <div class="usa-alert usa-alert--info usa-alert--no-icon">
                <div class="usa-alert__body">
                  <p class="usa-alert__text">
                    Upload NOFO to see differences.
                  </p>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
        {% else %}
        {# display_mode="single": Show consolidated view #}
          <div class="nofo_view--table-container">
            {% for section in comparison %}
              <table id="section--{{ section.html_id }}" class="section section--{{ forloop.counter }} {% if forloop.counter > 7 %}section--appendix {% endif %}section--{{ section.html_id }}{% if section.html_class %} {{ section.html_class }}{% endif %}">
                <tr class="section--content">
                  <td>
                    <h2 id="{{ section.html_id }}" >{{ section.name }}</h2>
                  </td>
                </tr>
                {% for subsection in section.subsections %}
                  <tr class="section--content">
                    {% with tag=subsection.tag content=subsection.name id=subsection.html_id class=subsection.html_class %}
                      <td>{% include "includes/heading.html" with tag=tag content=content id=id class=class only %}</td>
                    {% endwith %}
                  </tr>
                  <tr class="section--content">
                    <td>
                      {% if subsection.diff %}
                        {{ subsection.diff|safe|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
                      {% elif subsection.old_value %}
                        {{ subsection.old_value|safe_markdown|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
                      {% elif subsection.new_value %}
                        {{ subsection.new_value|safe_markdown|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </table>
            {% endfor %}
          </div>
          <div class="nofo_view--vertical-divider mr-0"></div>
            <div class="nofo_view--changes">
              <div class="usa-alert usa-alert--info usa-alert--no-icon  margin-bottom-2">
                <div class="usa-alert__body">
                  <p class="usa-alert__text">
                    {% if num_changed_subsections == 0 %}
                      Your NOFO has no changes.
                    {% elif num_changed_subsections == 1 %}
                      Your NOFO has changes in 1 section.
                    {% else %}
                      Your NOFO has changes in {{ num_changed_subsections }} sections.
                    {% endif %}
                  </p>
                </div>
              </div>
              <div class="nofo_view--changes--list">
                <ol>
                  {% for changed_subsection in changed_subsections %}
                    <li>
                      <a href="#{{ changed_subsection.html_id }}">{{ forloop.counter }}. {{ changed_subsection.name|strip_br_ins_del }}<br />{{ changed_subsection.status }}</a>
                    </li>
                  {% endfor %}
                </ol>
              </div>
            </div>
        {% endif %}
      </div>
    </div>
{% endblock %}

{% block js_footer %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const OFFSET = 130; // 5px more than scroll-margin-top
    const navLinks = Array.from(document.querySelectorAll(".nofo_view--changes--list a"));
    const prevBtn = document.querySelector(".nofo_view--menu-bar--button__expand_less");
    const nextBtn = document.querySelector(".nofo_view--menu-bar--button__expand_more");

    const sections = navLinks.map(link => {
      const id = link.getAttribute("href").substring(1);
      const heading = document.querySelector(`#${CSS.escape(id)}`);
      return { link, heading };
    }).filter(item => item.heading);

    function setButtonState() {
      if (navLinks.length === 0) {
        prevBtn.setAttribute("aria-disabled", "true");
        nextBtn.setAttribute("aria-disabled", "true");
        return;
      }

      const activeIndex = navLinks.findIndex(link => link.parentElement.classList.contains("is-active"));

      // If no active link yet
      if (activeIndex === -1) {
        prevBtn.setAttribute("aria-disabled", "true");
        nextBtn.removeAttribute("aria-disabled");
        nextBtn.onclick = () => navLinks[0].click();
        return;
      }

      // Previous button
      if (activeIndex > 0) {
        prevBtn.removeAttribute("aria-disabled");
        prevBtn.onclick = () => navLinks[activeIndex - 1].click();
      } else {
        prevBtn.setAttribute("aria-disabled", "true");
        prevBtn.onclick = null;
      }

      // Next button
      if (activeIndex < navLinks.length - 1) {
        nextBtn.removeAttribute("aria-disabled");
        nextBtn.onclick = () => navLinks[activeIndex + 1].click();
      } else {
        nextBtn.setAttribute("aria-disabled", "true");
        nextBtn.onclick = null;
      }
    }


    function updateActiveNav() {
      let current = null;

      for (let i = 0; i < sections.length; i++) {
        const rect = sections[i].heading.getBoundingClientRect();
        if (rect.top - OFFSET <= 0) {
          current = sections[i];
        } else {
          break;
        }
      }

      // No active if above first section
      if (sections.length > 0 && sections[0].heading.getBoundingClientRect().top - OFFSET > 0) {
        current = null;
      }

      navLinks.forEach(link => link.parentElement.classList.remove("is-active"));
      if (current) {
        current.link.parentElement.classList.add("is-active");
      }

      setButtonState();
    }

    // "passive: true" improves scroll performance
    window.addEventListener("scroll", updateActiveNav, { passive: true });
    updateActiveNav(); // run on page load
  });
</script>
{% endblock %}
