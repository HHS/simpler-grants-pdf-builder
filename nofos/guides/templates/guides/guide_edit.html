{% extends 'base.html' %}
{% load martortags tz get_value_or_none add_classes_to_tables convert_paragraphs_to_hrs %}


{% block title %}
  Configure Content Guide: “{{ guide.title }}”
{% endblock %}

{% block body_class %}content_guide_edit{% endblock %}

{% block content %}
  {% include "includes/alerts.html" with messages=messages success_heading="Content Guide saved successfully" error_heading="Subsection deleted" only %}

  {% if guide.archived %}
    {% if guide.successor %}
      {% include "includes/warning_successor.html" with document=guide user=user class_name="margin-bottom-3" only %}
    {% else %}
      {% include "includes/warning_archived.html" with document=guide user=user class_name="margin-bottom-3" only %}
    {% endif %}
  {% endif %}

  <div class="back-link font-body-md">
    {% if new_nofo %}
      <a class="usa-button--icon--before usa-button--arrow_back" href="{% url 'guides:guide_compare_result' guide.id new_nofo.id %}">Review the differences</a>
    {% else %}
      <a class="usa-button--icon--before usa-button--arrow_back" href="{% url 'guides:guide_index' %}">All content guides</a>
    {% endif %}
  </div>
  <div class="nofo_guide_edit--header nofo_edit--header--sticky" id="nofo_edit--header--id">
    <div class="nofo_guide_edit--header--h1">
      <h1 class="font-heading-md margin-top-2 margin-bottom-105">{{ guide.title }}</h1>
    </div>
  </div>

  {% timezone "America/New_York" %}
    <p>
      <em>This content guide was uploaded on <strong>{{ guide.created|date:'F j' }} at {{ guide.created|date:'g:i A' }}</strong></em>.
    </p>
  {% endtimezone %}

  <div class="usa-prose">
    <p>Select “Ready to Compare” to review the differences between your content guide and an uploaded NOFO.
    If you would like to upload a new version of your content guide, select “Replace this Content Guide.”</p>
  </div>

  <ul class="usa-button-group margin-top-2">
    <li class="usa-button-group__item">
      {% if new_nofo %}
        <a class="usa-button" href="{% url 'guides:guide_compare_result' guide.id new_nofo.id %}">Return to comparison</a>
      {% else %}
        <a class="usa-button" href="{% url 'guides:guide_compare_upload' guide.id %}">Upload NOFO to compare</a>
      {% endif %}
    </li>
    <li class="usa-button-group__item">
      <a class="usa-button usa-button--outline" href="{% url 'guides:guide_import' %}">Replace this content guide</a>
    </li>
  </ul>

  <table class="usa-table usa-table--borderless width-full table--hide-edit-if-archived margin-bottom-6">
    <caption>
      <div>
        <h2 class="margin-bottom-0">Content guide info</h2>
      </div>
    </caption>
    <thead class="usa-sr-only">
      <tr>
        <th scope="col">Key</th>
        <th scope="col">Value</th>
        <th scope="col">Manage</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th scope="row">Name</th>
        <td>{{ guide.title }}</td>
        <td><a href="{% url 'guides:guide_edit_title' guide.id %}">Edit<span class="usa-sr-only"> content guide name</span></a>
        </td>
      </tr>
      {% if user.group == 'bloom' %}
        <tr>
          <th scope="row">Group</th>
          <td>
            <span class="usa-tag bg-group bg-group--{{ guide.group }}">{{ guide.group }}</span>
          </td>
          <td><a href="{% url 'guides:guide_edit_group' guide.id %}">Edit<span class="usa-sr-only"> content guide group</span></a>
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>

  <h2>Which sections of this content guide would you like to compare to a NOFO?</h2>
  <ul class="usa-list">
    <li>Selecting a section will compare all the content in that section.</li>
    <li>Any sections you don't select won't be compared.</li>
    <li>Headings within each section will always be compared.</li>
    <li>Expand each section to see what content it includes.
  </ul>

  <div class="compare-all-sections-container"
       data-url="{% url 'guides:guide_edit' guide.id %}"
       data-csrf-token="{{ csrf_token }}">
    <div class="usa-checkbox flipped-label">
      <input
        class="usa-checkbox__input"
        id="compare-all-sections"
        type="checkbox"
        name="compare_all"
        value="all"
      />
      <label class="usa-checkbox__label" for="compare-all-sections">
        Compare All Sections
      </label>
    </div>
  </div>

  <div class="usa-accordion usa-accordion--bordered">
    {% for section in guide.sections.all|dictsort:"order" %}
      <h3 class="usa-accordion__heading usa-accordion__compare-heading">
        <button
          type="button"
          class="usa-accordion__button"
          aria-expanded="false"
          aria-controls="section-{{ section.id }}"
        >
          {{ section.name }}
        </button>
        <div class="usa-checkbox usa-accordion__compare-checkbox flipped-label">
          <input
            class="usa-checkbox__input"
            id="compare-section-{{ section.id }}"
            type="checkbox"
            name="compare_sections"
            value="{{ section.id }}"
            onclick="event.stopPropagation();"
          />
          <label class="usa-checkbox__label usa-accordion__compare-checkbox-label" for="compare-section-{{ section.id }}" onclick="event.stopPropagation();">
            Compare Content
          </label>
        </div>
      </h3>
      <div id="section-{{ section.id }}" class="usa-accordion__content usa-prose">
        <table class="usa-table usa-table--borderless width-full table--section">
          <thead>
            <tr>
              <th scope="col">Heading</th>
              <th scope="col">Content</th>
              <th scope="col"><span class="usa-sr-only">Manage comparison</span></th>
            </tr>
          </thead>
          <tbody>
            {% for subsection in section.subsections.all|dictsort:"order" %}
              {% if subsection.name != 'Basic information' %}
              <tr class="row--comparison-type--{{ subsection.comparison_type }}">
                <th scope="row"
                  class="w-20 nofo-edit-table--subsection--name{% if subsection.html_class %} {{ subsection.html_class }}{% endif %}">
                  <span class="floating">
                    {% if subsection.name %}
                      <span {% if subsection.comparison_type == 'none' %}class="text-base text-italic"{% endif %}>
                        {{ subsection.name }}
                      </span>
                    {% else %}
                      <span class="text-base">—</span>
                    {% endif %}
                  </span>
                </th>
                <td class="nofo-edit-table--subsection--body">
                  {{ subsection.body|safe_markdown|add_classes_to_tables|convert_paragraphs_to_hrs|get_value_or_none:"content" }}
                </td>
                <td class="width-4 nofo-edit-table--subsection--manage width-10 height-6">
                  <div class="usa-checkbox ">
                    <input
                      class="usa-checkbox__input"
                      id="compare-subsection-{{ subsection.id }}"
                      type="checkbox"
                      name="compare_subsections"
                      value="{{ subsection.id }}"
                      {% if subsection.comparison_type == 'body' %}checked{% endif %}
                    />
                    <label class="usa-checkbox__label" for="compare-subsection-{{ subsection.id }}">
                      <span class="usa-sr-only">Compare subsection: {{ subsection.name }}</span>
                    </label>
                  </div>
                </td>
              </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const compareAllCheckbox   = document.getElementById('compare-all-sections');
  const sectionCheckboxes    = document.querySelectorAll('input[name="compare_sections"]');
  const subsectionCheckboxes = document.querySelectorAll('input[name="compare_subsections"]');
  const allCheckboxes        = [compareAllCheckbox, ...sectionCheckboxes, ...subsectionCheckboxes];
  const usaButtons           = document.querySelectorAll('.usa-button');
  const container            = document.querySelector('.compare-all-sections-container'); // has data-url + data-csrf-token

  /* ------------------------- small helpers ------------------------- */

  // Create or remove a slim USWDS alert just after .usa-list
  function showAlert(message, status = 'warning') {
    const summaryList = document.querySelector('.usa-list');
    if (!summaryList) return;

    // remove existing alert if present
    document.getElementById('compare-alert')?.remove();

    const el = document.createElement('div');
    el.id = 'compare-alert';
    el.className = `usa-alert usa-alert--${status} usa-alert--slim margin-top-2`;
    el.setAttribute('role', 'alert');
    el.setAttribute('tabindex', '-1');
    el.innerHTML = `<div class="usa-alert__body"><p class="usa-alert__text">${message}</p></div>`;
    summaryList.after(el);
    el.focus();

    // auto-remove after 4s
    setTimeout(() => el.remove(), 4000);
  }

  function setControlsDisabled(disabled) {
    allCheckboxes.forEach(cb => cb.disabled = disabled);
    usaButtons.forEach(btn => btn.disabled = disabled);
  }

  function updateUsaButtons() {
    const noneChecked = allCheckboxes.every(cb => !cb.checked);
    usaButtons.forEach(btn => {
      btn.toggleAttribute('aria-disabled', noneChecked);
      btn.toggleAttribute('disabled',      noneChecked);
      btn.classList.toggle('disabled-link', noneChecked);
    });
    if (noneChecked) {
      showAlert('Please select at least one section or subsection to compare.', 'warning');
    } else {
      document.getElementById('compare-alert')?.remove();
    }
  }

  // Map a NodeList of checkboxes to { checkbox -> {current, desired} }
  function buildCheckboxValueMap(nodes, desired) {
    const map = new Map();
    nodes.forEach(cb => {
      map.set(cb, { current: cb.checked, desired });
      cb.checked = desired;
    });
    return map;
  }

  // Keep the tri-state "Compare All" checkbox accurate
  function updateCompareAllSectionsCheckbox() {
    const list = [...sectionCheckboxes, ...subsectionCheckboxes];
    const allChecked = list.every(cb => cb.checked);
    const anyChecked = list.some(cb => cb.checked);
    compareAllCheckbox.checked = allChecked;
    compareAllCheckbox.indeterminate = !allChecked && anyChecked;
  }

  // Keep each section checkbox in sync with its subsections
  function updateCompareSectionCheckboxes() {
    sectionCheckboxes.forEach(sectionCheckbox => {
      const sectionId = sectionCheckbox.value;
      const sectionSubs = document.querySelectorAll(`#section-${sectionId} input[name="compare_subsections"]`);
      if (!sectionSubs.length) return;

      const allChecked = [...sectionSubs].every(cb => cb.checked);
      const anyChecked = [...sectionSubs].some (cb => cb.checked);
      sectionCheckbox.checked = allChecked;
      sectionCheckbox.indeterminate = !allChecked && anyChecked;
    });
  }

  /* ----------------------------- save ------------------------------ */

  async function saveSubsectionSelections(checkboxValueMap, elementForFocus) {
    const url       = container?.dataset.url;
    const csrfToken = container?.dataset.csrfToken;
    if (!url || !csrfToken) {
      console.error('Missing URL or CSRF token on .compare-all-sections-container');
      return;
    }

    setControlsDisabled(true);

    // body: { subsections: { "<id>": true|false } }
    const subsections = Object.fromEntries(
      [...checkboxValueMap.entries()].map(([cb, v]) => [cb.value, v.desired])
    );

    try {
      const res  = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        credentials: 'same-origin',
        body: JSON.stringify({ subsections })
      });
      const data = await res.json();

      if (data.status === 'success') {
        console.log(`Subsection selections saved. ${data.updated_count} updated.`);
      } else if (data.status === 'fail') {
        console.error(data.message);
      } else if (data.status === 'partial') {
        console.warn(data.message);
      }

      // Revert any failed IDs to their previous state
      (data.failed_subsection_ids || []).forEach(failedId => {
        const failed = document.querySelector(`input[name="compare_subsections"][value="${failedId}"]`);
        if (!failed) return;
        for (const [mapCb, values] of checkboxValueMap.entries()) {
          if (mapCb.value === failedId) {
            failed.checked = values.current;
            break;
          }
        }
      });

      if (data.status !== 'success') {
        showAlert(data.message || 'There was a problem saving your selection.', data.status === 'fail' ? 'error' : 'warning');
        elementForFocus?.focus();
      }
    } catch (err) {
      console.error('Error saving subsection selections:', err);
      showAlert('There was a problem saving your selection.', 'error');
      elementForFocus?.focus();
    } finally {
      updateCompareSectionCheckboxes();
      updateCompareAllSectionsCheckbox();
      setControlsDisabled(false);
      updateUsaButtons();
    }
  }

  // Expose for other parts of the page that may call it
  window.saveSubsectionSelections = saveSubsectionSelections;

  /* --------------------------- event wires ------------------------- */

  // "Compare All Sections" toggles all sections + subsections
  compareAllCheckbox.addEventListener('change', function () {
    const desired = this.checked;
    const map = buildCheckboxValueMap(subsectionCheckboxes, desired);
    // also reflect on all section checkboxes
    sectionCheckboxes.forEach(cb => cb.checked = desired);
    saveSubsectionSelections(map, this);
  });

  // A section checkbox toggles only its own subsections
  sectionCheckboxes.forEach(sectionCheckbox => {
    sectionCheckbox.addEventListener('change', function () {
      const sectionId  = this.value;
      const desired    = this.checked;
      const sectionSubs = document.querySelectorAll(`#section-${sectionId} input[name="compare_subsections"]`);
      const map = buildCheckboxValueMap(sectionSubs, desired);
      saveSubsectionSelections(map, this);
    });
  });

  // Individual subsection checkbox
  subsectionCheckboxes.forEach(subsectionCheckbox => {
    subsectionCheckbox.addEventListener('change', function () {
      const map = new Map([[this, { current: !this.checked, desired: this.checked }]]);
      saveSubsectionSelections(map, this);
    });
  });

  /* --------------------------- initial sync ------------------------ */
  updateCompareSectionCheckboxes();
  updateCompareAllSectionsCheckbox();
  updateUsaButtons();
});
</script>
{% endblock %}
