{% extends 'base.html' %}
{% load martortags tz nofo_name get_value_or_none add_classes_to_tables convert_paragraphs_to_hrs %}


{% block title %}
  Configure Content Guide: “{{ guide.title }}”
{% endblock %}

{% block body_class %}content_guide_edit{% endblock %}

{% block content %}
  {% include "includes/alerts.html" with messages=messages success_heading="Content Guide saved successfully" error_heading="Subsection deleted" only %}

  {% if guide.archived %}
    {% if guide.successor %}
      {% include "includes/warning_successor.html" with document=guide user=user class_name="margin-bottom-3" only %}
    {% else %}
      {% include "includes/warning_archived.html" with document=guide user=user class_name="margin-bottom-3" only %}
    {% endif %}
  {% endif %}

  <div class="back-link font-body-md">
    {% if new_nofo %}
      <a href="{% url 'guides:guide_compare_result' guide.id new_nofo.id %}">Review the differences</a>
    {% else %}
      <a href="{% url 'guides:guide_index' %}">All content guides</a>
    {% endif %}
  </div>
  <div class="nofo_guide_edit--header nofo_edit--header--sticky" id="nofo_edit--header--id">
    <div class="nofo_guide_edit--header--h1 ">
      <h1 class="font-heading-md margin-top-1">{{ guide.title }}</h1>
    </div>
  </div>

  {% timezone "America/New_York" %}
    <p>
      <em>This Content Guide was uploaded on <strong>{{ guide.created|date:'F j' }} at {{ guide.created|date:'g:i A' }}</strong></em>.
    </p>
  {% endtimezone %}

  <p>Select “Ready to Compare” to review the differences between your content guide and an uploaded NOFO.
    If you would like to upload a new version of your content guide, select “Replace this Content Guide.”</p>

  <ul class="usa-button-group margin-top-2 margin-bottom-4">
    <li class="usa-button-group__item">
      {% if new_nofo %}
        <a class="usa-button" href="{% url 'guides:guide_compare_result' guide.id new_nofo.id %}">Return to comparison</a>
      {% else %}
        <a class="usa-button" href="{% url 'guides:guide_compare_upload' guide.id %}">Upload NOFO to compare</a>
      {% endif %}
    </li>
    <li class="usa-button-group__item">
      <a class="usa-button usa-button--outline" href="{% url 'guides:guide_import' %}">Replace this content guide</a>
    </li>
  </ul>

  <h2>Which sections of this content guide would you like to compare to a NOFO?</h2>
  <ul class="usa-list">
    <li>Selecting a section will compare all the content in that section.</li>
    <li>Any sections you don't select won't be compared.</li>
    <li>Headings within each section will always be compared.</li>
    <li>Expand each section to see what content it includes.
  </ul>

  <div class="compare-all-sections-container"
       data-url="{% url 'guides:guide_edit' guide.id %}"
       data-csrf-token="{{ csrf_token }}">
    <div class="usa-checkbox flipped-label">
      <input
        class="usa-checkbox__input"
        id="compare-all-sections"
        type="checkbox"
        name="compare_all"
        value="all"
      />
      <label class="usa-checkbox__label" for="compare-all-sections">
        Compare All Sections
      </label>
    </div>
  </div>

  <div class="usa-accordion usa-accordion--bordered">
    {% for section in guide.sections.all|dictsort:"order" %}
      <h3 class="usa-accordion__heading usa-accordion__compare-heading">
        <button
          type="button"
          class="usa-accordion__button"
          aria-expanded="false"
          aria-controls="section-{{ section.id }}"
        >
          {{ section.name }}
        </button>
        <div class="usa-checkbox usa-accordion__compare-checkbox flipped-label">
          <input
            class="usa-checkbox__input"
            id="compare-section-{{ section.id }}"
            type="checkbox"
            name="compare_sections"
            value="{{ section.id }}"
            onclick="event.stopPropagation();"
          />
          <label class="usa-checkbox__label usa-accordion__compare-checkbox-label" for="compare-section-{{ section.id }}" onclick="event.stopPropagation();">
            Compare Content
          </label>
        </div>
      </h3>
      <div id="section-{{ section.id }}" class="usa-accordion__content usa-prose">
        <table class="usa-table usa-table--borderless width-full table--section">
          <thead>
            <tr>
              <th scope="col">Heading</th>
              <th scope="col">Content</th>
              <th scope="col"><span class="usa-sr-only">Manage comparison</span></th>
            </tr>
          </thead>
          <tbody>
            {% for subsection in section.subsections.all|dictsort:"order" %}
              {% if subsection.name != 'Basic information' %}
              <tr class="row--comparison-type--{{ subsection.comparison_type }}">
                <th scope="row"
                  class="w-20 nofo-edit-table--subsection--name{% if subsection.html_class %} {{ subsection.html_class }}{% endif %}">
                  <span class="floating">
                    {% if subsection.name %}
                      <span {% if subsection.comparison_type == 'none' %}class="text-base text-italic"{% endif %}>
                        {{ subsection.name }}
                      </span>
                    {% else %}
                      <span class="text-base">—</span>
                    {% endif %}
                  </span>
                </th>
                <td class="nofo-edit-table--subsection--body">
                  {{ subsection.body|safe_markdown|add_classes_to_tables|convert_paragraphs_to_hrs|get_value_or_none:"content" }}
                </td>
                <td class="width-4 nofo-edit-table--subsection--manage">
                  <div class="usa-checkbox ">
                    <input
                      class="usa-checkbox__input"
                      id="compare-subsection-{{ subsection.id }}"
                      type="checkbox"
                      name="compare_subsections"
                      value="{{ subsection.id }}"
                      {% if subsection.comparison_type == 'body' %}checked{% endif %}
                    />
                    <label class="usa-checkbox__label" for="compare-subsection-{{ subsection.id }}">
                      <span class="usa-sr-only">Compare subsection: {{ subsection.name }}</span>
                    </label>
                  </div>
                </td>
              </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const compareAllCheckbox = document.getElementById('compare-all-sections');
    const sectionCheckboxes = document.querySelectorAll('input[name="compare_sections"]');
    const subsectionCheckboxes = document.querySelectorAll('input[name="compare_subsections"]');
    const allCheckboxes = [compareAllCheckbox, ...sectionCheckboxes, ...subsectionCheckboxes];

    // Handle "Compare All Sections" checkbox
    compareAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;

        // Check/uncheck all section checkboxes
        sectionCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });

        // Check/uncheck all subsection checkboxes
        const checkboxValueMap = new Map();
        subsectionCheckboxes.forEach(checkbox => {
            checkboxValueMap.set(checkbox, {
                current: checkbox.checked,
                desired: isChecked
            });
            checkbox.checked = isChecked;
        });

        saveSubsectionSelections(checkboxValueMap);
    });

    // Handle individual section "Compare Content" checkboxes
    sectionCheckboxes.forEach(sectionCheckbox => {
        sectionCheckbox.addEventListener('change', function() {
            const sectionId = this.value;
            const isChecked = this.checked;

            // Find all subsection checkboxes for this section
            const sectionSubsectionCheckboxes = document.querySelectorAll(`#section-${sectionId} input[name="compare_subsections"]`);

            const checkboxValueMap = new Map();
            sectionSubsectionCheckboxes.forEach(checkbox => {
                checkboxValueMap.set(checkbox, {
                    current: checkbox.checked,
                    desired: isChecked
                });
                checkbox.checked = isChecked;
            });
            saveSubsectionSelections(checkboxValueMap);
        });
    });

    // Handle individual subsection checkboxes
    subsectionCheckboxes.forEach(subsectionCheckbox => {
        subsectionCheckbox.addEventListener('change', function() {
            // Create map for just this checkbox that was clicked
            const checkboxValueMap = new Map();
            checkboxValueMap.set(this, {
                current: !this.checked, // Previous state (opposite of current after click)
                desired: this.checked   // New state (current after click)
            });

            // Save the selection for this individual checkbox
            saveSubsectionSelections(checkboxValueMap);
        });
    });

    // Function to update the "Compare All Sections" checkbox state
    function updateCompareAllSectionsCheckbox() {
        const allCheckboxes = [...sectionCheckboxes, ...subsectionCheckboxes];
        const allChecked = allCheckboxes.every(checkbox => checkbox.checked);
        const anyChecked = allCheckboxes.some(checkbox => checkbox.checked);

        if (allChecked) {
            compareAllCheckbox.checked = true;
            compareAllCheckbox.indeterminate = false;
        } else if (anyChecked) {
            compareAllCheckbox.checked = false;
            compareAllCheckbox.indeterminate = true;
        } else {
            compareAllCheckbox.checked = false;
            compareAllCheckbox.indeterminate = false;
        }
    }

    // Function to update section checkboxes based on their subsection states
    function updateCompareSectionCheckboxes() {
        sectionCheckboxes.forEach(sectionCheckbox => {
            const sectionId = sectionCheckbox.value;

            // Find all subsection checkboxes for this section
            const sectionSubsectionCheckboxes = document.querySelectorAll(`#section-${sectionId} input[name="compare_subsections"]`);

            if (sectionSubsectionCheckboxes.length > 0) {
                // Check if all subsections in this section are checked
                const allSectionSubsectionsChecked = Array.from(sectionSubsectionCheckboxes).every(checkbox => checkbox.checked);

                // Update section checkbox based on subsection states
                sectionCheckbox.checked = allSectionSubsectionsChecked;
            }
        });
    }

    function saveSubsectionSelections(checkboxValueMap) {
        // Get the container with data attributes
        const container = document.querySelector('.compare-all-sections-container');
        const url = container.dataset.url;
        const csrfToken = container.dataset.csrfToken;

        allCheckboxes.forEach(checkbox => {
            checkbox.disabled = true;
        });

        // Collect all subsection checkbox states from the map
        const subsectionStates = {};
        for (let [checkbox, values] of checkboxValueMap.entries()) {
            subsectionStates[checkbox.value] = values.desired;
        }

        // Make POST request
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                subsections: subsectionStates
            })
        })
        .then(response => {
            return response.json();
        })
        .then(data => {
            if (data.status == 'success') {
                console.log(`Subsection selections saved successfully. ${data.updated_count} subsections updated.`);
            } else if (data.status == 'fail') {
                console.error(data.message);
            } else if (data.status == 'partial') {
                console.warn(data.message);
            }

            // Handle failed subsection IDs by reverting their checkboxes to previous state
            if (data.failed_subsection_ids && data.failed_subsection_ids.length > 0) {
                data.failed_subsection_ids.forEach(failedId => {
                    const checkbox = document.querySelector(`input[name="compare_subsections"][value="${failedId}"]`);
                    if (checkbox) {
                        // Find the checkbox in our value map and revert to current (previous) state
                        for (let [mapCheckbox, values] of checkboxValueMap.entries()) {
                            if (mapCheckbox.value === failedId) {
                                checkbox.checked = values.current;
                                break;
                            }
                        }
                        indicateCheckboxError(checkbox);
                    }
                });
            }
            if (data.status !== 'success') {
                showMessage(data);
            }
        })
        .catch(error => {
            console.error('Error saving subsection selections:', error);
        })
        .finally(() => {
            updateCompareSectionCheckboxes();
            updateCompareAllSectionsCheckbox();
            allCheckboxes.forEach(checkbox => {
                checkbox.disabled = false;
            });
        });
    }

    function showMessage(data) {
            // Create a simple message div
            const messageDiv = document.createElement('div');
            messageDiv.className = `usa-alert usa-alert--${data.status === 'success' ? 'success' : data.status === 'fail' ? 'error' : 'warning'} usa-alert--slim margin-top-2`;
            messageDiv.innerHTML = `
                <div class="usa-alert__body">
                    <p class="usa-alert__text">${data.message}</p>
                </div>
            `;

            // Insert after the summary box
            const summaryBox = document.querySelector('.usa-list');
            summaryBox.parentNode.insertBefore(messageDiv, summaryBox.nextSibling);

            // Remove message after 4 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 4000);
    }

    function indicateCheckboxError(checkbox) {
        // TODO: indicate the checkbox as having an error
    }

    // Expose the function globally so it can be called from other parts of the page
    window.saveSubsectionSelections = saveSubsectionSelections;

    // Initialize the state on page load
    updateCompareSectionCheckboxes();
    updateCompareAllSectionsCheckbox();
});
</script>
{% endblock %}
