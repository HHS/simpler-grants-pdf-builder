{% extends 'base.html' %}
{% load tz martortags add_classes_to_tables add_footnote_ids add_captions_to_tables add_classes_to_lists add_classes_to_paragraphs convert_paragraphs_to_hrs conditional_questions_note nofo_section_name_separator %}

{% block title %}
  {{ document.title }} — {{ current_section.name }}</title>
{% endblock %}

{% block body_class %}composer_document_section{% endblock %}

{% block content %}
  <div class="grid-row">
    {% include "includes/alerts.html" with messages=messages success_heading=success_heading error_heading=error_heading stick_to_bottom=True only %}
    <div class="back-link font-body-md margin-bottom-105">
      <a class="usa-button--icon--before usa-button--icon--usa-blue usa-button--arrow_back" href="{% url 'composer:composer_index' %}">Home</a>
    </div>
  </div>
  <div class="grid-row cg-layout">
    <!-- sticky sidenav -->
    {% include 'includes/_side_nav.html' with document_pk=document.pk sections=sections %}

    <!-- current_section content -->
    <main class="grid-col-9">
        <div class="subhead--document-name font-sans-md text-base margin-bottom-05">{{ document.title }}</div>
        <div class="display-flex flex-justify flex-align-start margin-bottom-1">
          <h1 class="margin-bottom-0 margin-top-05 font-serif-xl">
            {% with current_section.name|nofo_section_name_separator as section_name %}
              {{ section_name.name }}
            {% endwith %}
          </h1>
          <a href="{% url 'composer:composer_preview' document.pk %}" class="usa-button">Preview</a>
        </div>
      {% timezone "America/New_York" %}
        <p>
          <em>Last updated on <strong>{{ document.updated|date:'F j' }} at {{ document.updated|date:'g:i A' }}</strong></em> — <a href="{% url 'composer:composer_history' document.id %}">See all updates</a>
        </p>
      {% endtimezone %}
      <ul class="line-height-sans-5">
        <li>Review and update the content guide.</li>
        <li>Select “Edit” to set how much control OpDivs and writers have.</li>
        <li>Tags (e.g., Locked, Certain text, Optional) show those permissions and can be changed when editing.</li>
      </ul>
      <details class="explainer-box">
        <summary class="bg-accent-warm-dark text-white padding-1">Guide to the tags</summary>
        <div class="explainer-box--content border border-accent-warm-dark border-radius-sm">
          <ul class="usa-prose">
            <li>No tag means all text in the section can be edited and changed.</li>
            <li>
              <div class="display-flex">
                <div class="minw-fit-content margin-right-1">{% include "includes/subsection_labels.html" with edit_mode='locked' %}</div>
                <div>is a section writers cannot edit or make changes.</div>
              </div>
            </li>
            <li>
              <div class="display-flex">
                <div class="minw-fit-content margin-right-1">{% include "includes/subsection_labels.html" with edit_mode='variables' %}</div>
                <div>means writers can edit certain text only in this section. Only text inside the brackets can be changed.</div>
              </div>
            </li>
            <li>
              <div class="display-flex">
                <div class="minw-fit-content margin-right-1">{% include "includes/subsection_labels.html" with optional=True %}</div>
                <div>means this section is not required for the writer to answer. No text in the section can be edited or changed. </div>
              </div>
            </li>
            <li>
              <div class="display-flex">
                <div class="minw-fit-content margin-right-1">
                  <div class="margin-bottom-1">{% include "includes/subsection_labels.html" with conditional_answer=True %}</div>
                  <div>{% include "includes/subsection_labels.html" with conditional_answer=False %}</div>
                </div>
                <div>means this section has associated text if writer has selected yes or no.</div>
              </div>

            </li>
          </ul>
        </div>
      </details>
      <hr />
      <ul class="margin-top-2 margin-x-0 usa-button-group flex-justify-end">
        <li><a class="usa-button usa-button--unstyled" href="{% url 'composer:section_edit' document.pk current_section.pk %}">Configure section</a></li>
        <li><button id="expand-collapse-all" class="usa-button usa-button--outline usa-button--icon--after usa-button--add">Expand all</button></li>
      </ul>

      <div class="border-bottom border-base-lighter border-bottom-width-1px">
      <!-- Header blocks (h2/h3 + pre-identified heading names)  -->
      {% for grouped_subsection in grouped_subsections %}
        <h3 class="margin-top-0">{{ grouped_subsection.heading }}</h3>
        <div class="margin-bottom-4">
        {# Header item + subsequent items #}
        {% for subsection in grouped_subsection.items %}
          <div id="{{ subsection.html_id }}" class="usa-accordion usa-accordion--multiselectable usa-accordion--bordered" data-allow-multiple>
            <h4 class="usa-accordion__heading">
              <button class="usa-accordion__button display-flex flex-justify"
                      aria-controls="accordion-{{ subsection.pk }}"
                      {% if anchor == subsection.html_id %}
                        aria-expanded="true"
                      {% else %}
                        aria-expanded="false"
                      {% endif %}
                      >
                {{ subsection.name|default:"(No title)" }}
                <div class="flex-row">
                  {% include "includes/subsection_labels.html" with conditional_answer=subsection.conditional_answer optional=subsection.optional edit_mode=subsection.edit_mode only %}
                </div>
              </button>
            </h4>
            <div id="accordion-{{ subsection.pk }}" class="usa-accordion__content usa-prose">
              {% with subsection|conditional_questions_note as conditional_note %}
                {% if conditional_note %}
                  <p class="margin-top-1">
                    {{ conditional_note|safe }}
                  </p>
                {% endif %}
              {% endwith %}
              {% if subsection.instructions %}
              <div class="position-relative padding-bottom-2 border-bottom border-base-lighter">
                <div class="bg-primary-lighter padding-2">
                  <div class="display-flex flex-justify flex-align-center">
                    <div class="font-heading-lg text-bold padding-top-1">Instructions</div>
                    <span class="bg-white"><a
                      class="usa-button usa-button--outline usa-button--compact"
                      href="{% url 'composer:instructions_edit' document.pk current_section.pk subsection.pk %}">
                        Edit instructions
                    </a></span>
                  </div>
                  <div>
                    {{ subsection.instructions|safe_markdown|add_classes_to_paragraphs|add_classes_to_lists|convert_paragraphs_to_hrs }}
                  </div>
                </div>
              </div>
              {% endif %}
              <div class="position-relative">
                <div class="font-heading-lg text-bold padding-top-1 margin-right-10">{{ subsection.name }}</div>
                <a
                  class="usa-button usa-button--outline usa-button--compact position-absolute top-0 right-0"
                  href="{% url 'composer:subsection_edit' document.pk current_section.pk subsection.pk %}">
                    Edit
                </a>
                <div class="usa-prose styled-subsection-body{% if subsection.edit_mode == 'variables' %}--variables{% elif subsection.edit_mode == 'full' %}--full{% endif %}">
                  {{ subsection.body|safe_markdown|add_classes_to_tables|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
        </div>
      {% endfor %}
      </div>

      <!-- Pager -->
      <nav class="display-flex flex-justify margin-top-4">
        <div>
          {% if prev_sec %}
            <a class="usa-button usa-button--outline"
                href="{% url 'composer:section_view' document.pk prev_sec.pk %}">
                ← {{ prev_sec.name }}
            </a>
          {% endif %}
        </div>
        <div>
          {% if next_sec %}
            <a class="usa-button"
                href="{% url 'composer:section_view' document.pk next_sec.pk %}">
                {{ next_sec.name }} →
            </a>
          {% endif %}
        </div>
      </nav>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const expandCollapseBtn = document.getElementById('expand-collapse-all');
      const accordionButtons = document.querySelectorAll('.usa-accordion__button');

      function updateButtonState() {
        // Check if all accordions are expanded
        const allExpanded = Array.from(accordionButtons).every(btn =>
          btn.getAttribute('aria-expanded') === 'true'
        );

        if (allExpanded) {
          expandCollapseBtn.textContent = 'Collapse all';
          expandCollapseBtn.classList.remove('usa-button--add');
          expandCollapseBtn.classList.add('usa-button--remove');
        } else {
          expandCollapseBtn.textContent = 'Expand all';
          expandCollapseBtn.classList.remove('usa-button--remove');
          expandCollapseBtn.classList.add('usa-button--add');
        }
      }

      expandCollapseBtn.addEventListener('click', function() {
        // Check current state
        const allExpanded = Array.from(accordionButtons).every(btn =>
          btn.getAttribute('aria-expanded') === 'true'
        );

        // Save current scroll position
        const currentScrollY = window.scrollY;

        // Toggle all accordions
        const buttonsArray = Array.from(accordionButtons);

        buttonsArray.forEach(btn => {
          if (allExpanded) {
            // Collapse all
            if (btn.getAttribute('aria-expanded') === 'true') {
              btn.click();
            }
          } else {
            // Expand all
            if (btn.getAttribute('aria-expanded') === 'false') {
              btn.click();
            }
          }
        });

        // Restore scroll position and focus on expand/collapse button to prevent auto-scrolling
        window.scrollTo(0, currentScrollY);
        expandCollapseBtn.focus();

        // Update button state after a brief delay to allow accordion animations
        setTimeout(updateButtonState, 100);
      });

      // Listen for changes to accordion states (in case user manually expands/collapses)
      accordionButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          setTimeout(updateButtonState, 100);
        });
      });

      // Initialize button state on page load
      updateButtonState();
    });
  </script>
{% endblock %}
