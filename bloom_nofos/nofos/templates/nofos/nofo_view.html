{% extends 'base_barebones.html' %}
{% load static martortags nofo_section_name_separator add_classes_to_tables add_footnote_ids callout_box_contents replace_unicode_with_icon add_classes_to_paragraphs add_captions_to_tables is_floating_callout_box split_char_and_remove add_classes_to_lists convert_paragraphs_to_hrs %}

{% block metadata %}
  {% if nofo.author %}
    <meta name="author" content="{{ nofo.author }}" >
  {% endif %}
  {% if nofo.subject %}
    <meta name="subject" content="{{ nofo.subject }}" >
  {% endif %}
  {% if nofo.keywords %}
    <meta name="keywords" content="{{ nofo.keywords }}" >
  {% endif %}
{% endblock %}

{% block css %}
  {% with "theme-orientation-"|add:nofo_theme_orientation|add:'.css' as filename_orientation %}
    <link href="{% static filename_orientation %}" type="text/css" media="all" rel="stylesheet">
  {% endwith %}

  {% with "theme-opdiv-"|add:nofo_opdiv|add:'.css' as filename_opdiv %}
    <link href="{% static filename_opdiv %}" type="text/css" media="all" rel="stylesheet">
  {% endwith %}

  {% with "theme-opdiv-"|add:nofo_theme_base|add:'.css' as filename %}
    <link href="{% static filename %}" type="text/css" media="all" rel="stylesheet">
  {% endwith %}

  {% if nofo.inline_css %}
    <style>{{ nofo.inline_css }}</style>
  {% endif %}
{% endblock %}

{% block title %}{{ nofo.title }}{% endblock %}

{% block body_class %}{{ nofo.theme }} {{ nofo_theme_orientation }} {{ nofo_opdiv }} {{ nofo_theme_base }} {{ nofo.number|lower }} {{ nofo.icon_style }}{% endblock %}

{% block header %}
  <header class="usa-header usa-header--basic">
    <div class="usa-nav-container">
      <div class="usa-navbar">
        <div class="usa-logo" style="margin-top: 1rem;">
          <em class="usa-logo__text">
            <a href="{% url 'nofos:nofo_index' %}" class="usa-nav-link">← All NOFOs</a>
          </em>
          {% if user.is_authenticated %}
            <a class="inline-block usa-tag--link" href="{% url 'test_mode' %}">
              {% if DOCRAPTOR_TEST_MODE %}
                <span class="usa-tag bg-accent-cool-dark">Test</span>
              {% else %}
                <span class="usa-tag bg-green">Live</span>
              {% endif %}
            </a>
          {% endif %}
        </div>
      </div>
      <nav aria-label="Primary navigation" class="usa-nav">
        <ul class="usa-nav__primary usa-accordion">
          <li class="usa-nav__primary-item">
            <a href="{% url 'nofos:nofo_edit' nofo.id %}" class="usa-nav-link">Edit this NOFO</a>
          </li>
          {% if request.user.is_superuser %}
            <li class="usa-nav__primary-item">
              <a href="{% url 'test_mode' %}?next={{ request.path }}" class="usa-nav-link">
                {% if DOCRAPTOR_TEST_MODE %}Deactivate ‘test mode’{% else %}Activate ‘test mode’{% endif %}
              </a>
            </li>
          {% endif %}
          <li class="usa-nav__primary-item">
            <form method="post" action="{% url 'nofos:print_pdf' nofo.id %}">
              {% csrf_token %}
              <!-- Adding inline styling here because I don't want to clutter up the CSS file with non-PDF css -->
              <button type="submit" class="usa-button" {% if request.scheme == 'http' %}disabled style="margin-bottom:5px;border-radius:.25rem;text-decoration:line-through;box-shadow: inset 0 0 0 2px #c9c9c9;"{% else %}style="margin-bottom:5px;border-radius:.25rem;color:white;background-color:#005ea2;"{% endif %}>
                Print{% if DOCRAPTOR_TEST_MODE %} test{% endif %} NOFO
              </button>
            </form>
          </li>
        </ul>
      </nav>
    </div>
  </header>
{% endblock %}

{% block content %}
  <!-- COVER PAGE -->
  <section id="section--cover-page" class="nofo--cover-page {{ nofo.cover }}">
    <div class="nofo--cover-page--header">
      <div class="nofo--cover-page--header--logo">
        {% with "includes/logos/"|add:nofo_opdiv|add:"-logo.svg" as opdiv_logo_path %}
          {% include opdiv_logo_path %}
        {% endwith %}
        <div class="nofo--cover-page--header--logo--subheading">
          {% if nofo.cover == 'nofo--cover-page--text' %}
            <p>{{ nofo.agency }}</p>
            <p>{% if nofo.subagency2 %}{{ nofo.subagency2 }}{% elif nofo.subagency %}{{ nofo.subagency }}{% endif %}</p>
          {% else %}
            <p>{% if nofo.subagency2 %}{{ nofo.subagency2 }}{% elif nofo.subagency %}{{ nofo.subagency }}{% else %}{{ nofo.agency }}{% endif %}</p>
          {% endif %}
        </div>
      </div>
      <div class="nofo--cover-page--header--intro">
        <span>Notice of Funding Opportunity</span>
        <br >
        <span>Application due {{ nofo.application_deadline }}</span>
      </div>
    </div>
    <div class="nofo--cover-page--hero-image">
      <img alt="" src="{% static nofo_cover_img %}">
    </div>
    <div class="nofo--cover-page--title">
      <div class="nofo--cover-page--title--block">
        <h1 {% if nofo.title|length > 120 %}class="nofo--cover-page--title--h1--smaller"{% endif %}>{{ nofo.title }}</h1>
        <div class="nofo--cover-page--title--subheading">
          <span>Opportunity number: {{ nofo.number }}</span>
        </div>
      </div>
      <div class="nofo--cover-page--title--logo">
        {% include "includes/logos/hhs-logo.svg" %}
      </div>
    </div>
    <div class="nofo--cover-page--footer">
      {# TODO: remove this once HRSA 014 ships #}
      <div class="nofo--cover-page--callout-box callout-box callout-box--icon callout-box--alert">
        <div class="callout-box--contents">
          {% include "includes/icons/000-alert.svg" %}
          <div>
            <p><strong>MODIFIED on March 8, 2024:</strong></p>
            <p>Updated the list of <a href="#100--step-3-write-your-application--other-required-forms">Other required forms</a> to include 3 additional required forms.</p>
            <br />
            <p><strong>MODIFIED on April 1, 2024:</strong></p>
            <p>Updated the <a href="#85--step-3-write-your-application--budget-budget-narrative">Budget & budget narrative section</a> to include budget requirements.</p>
          </div>
        </div>
      </div>

      <div class="nofo--cover-page--footer--logo">
        {% include "includes/logos/hhs-logo.svg" %}
      </div>
      <div class="nofo--cover-page--footer--subheading">
        <span>Notice of Funding Opportunity</span>
        <span>Application due {{ nofo.application_deadline }}</span>
      </div>
      <div class="nofo--cover-page--footer--image">
        <img alt="" src="{% static nofo_cover_img %}">
      </div>
    </div>
  </section>

  <section id="section--toc" class="toc">
    <h2 id="section--toc--heading">Contents</h2>
    {% spaceless %}
    <ol class="usa-list usa-list--unstyled">

      <li class="toc--section-name toc--no-icon toc--before-you-begin">
        <div class="toc--section-name--wrapper">
          <ol class="usa-list usa-list--unstyled">
            <li class="toc--subsection-name"><a href="#section--before-you-begin">Before you begin</a></li>
          </ol>
        </div>
      </li>

      {% for section in nofo.sections.all|dictsort:"order" %}
        {% if section.has_section_page %}
          <li class="toc--section-name">
            <div class="toc--section-name--img">
              {% include "includes/icon_macro.html" with section_name=section.name|lower only %}
            </div>
            <div class="toc--section-name--wrapper">
              <a href="#{{ section.html_id }}" class="toc--section-name--a">{{ section.name }}</a>

              {% if section.name|lower != "contacts & support" and section.name|lower != "contacts and support" %}
                <ol class="usa-list usa-list--unstyled">
                  {% for subsection in section.subsections.all|dictsort:"order" %}
                    {% with tag=subsection.tag content=subsection.name id=subsection.html_id %}
                      {% if tag == 'h3' %}
                        <li class="toc--subsection-name"><a href="#{{ subsection.html_id }}">{{ content }}</a></li>
                      {% endif %}
                    {% endwith %}
                  {% endfor %}
                </ol>
              {% endif %}
            </div>
          </li>
        {% else %}
          <li class="toc--section-name toc--no-icon toc--{{ section.html_id }}">
            <div class="toc--section-name--wrapper">
              <ol class="usa-list usa-list--unstyled">
                <li class="toc--subsection-name"><a href="#section--{{ section.html_id }}">{{ section.name }}</a></li>
              </ol>
            </div>
          </li>
        {% endif%}
      {% endfor %}
    </ol>
    {% endspaceless %}
  </section>

  <section id="section--before-you-begin" class="before-you-begin">
    <div class="section--before-you-begin--icon">
      {% include "includes/icons/0-before.svg" %}
    </div>
    <h2 id="section--before-you-begin--heading">Before you begin</h2>
    <div class="before-you-begin--content">

      <p>If you believe you are a good candidate for this funding opportunity, secure your <a href="https://sam.gov">SAM.gov</a> and <a href="https://grants.gov">Grants.gov</a> registrations now. If you are already registered, make sure your registration is active and up-to-date.</p>
      <p class="section--before-you-begin--psuedo-header">SAM.gov registration (this can take several weeks)</p>
      <p>You must have an active account with SAM.gov. This includes having a Unique Entity Identifier (UEI).</p>
      <a href="#step-2-get-ready-to-apply">See Step 2: Get Ready to Apply</a>

      <p class="section--before-you-begin--psuedo-header">Grants.gov registration (this can take several days)</p>
      <p>You must have an active Grants.gov registration. Doing so requires a Login.gov registration as well.</p>
      <a href="#step-2-get-ready-to-apply">See Step 2: Get Ready to Apply</a>

      <p class="section--before-you-begin--psuedo-header">Apply by {{ nofo.application_deadline|split_char_and_remove:"-" }}</p>
      <p>Applications are due by 11:59 p.m. Eastern Time on {{ nofo.application_deadline|split_char_and_remove:"-" }}.</p>

      {# Show "Adobe Reader" callout box in this section on non-HRSA 014 NOFOs #}
      {% if nofo.number|lower != 'hrsa-24-014' %}
      <div class="callout-box callout-box--icon callout-box--keyboard">
        <div class="callout-box--contents">
          {% include "includes/icons/00-adobe-pdf.svg" %}
            <p>To help you find what you need, this NOFO uses internal links. In Adobe Reader, you can go back to where you were by pressing Alt + Left Arrow (Windows) or Command + Left Arrow (Mac) on your keyboard.</p>
        </div>
      </div>
      {% endif %}
    </div>
  </section>

  {% for section in nofo.sections.all|dictsort:"order" %}
    <section id="section--{{ section.html_id }}" class="section section--{{ forloop.counter }} section--{{ section.html_id }}">
      <!-- SECTION TITLE PAGE -->
      {% if section.has_section_page %}
        <div class="title-page section--title-page">
          <div class="header-nav section--title-page--header-nav">
            <p>Jump to a step</p>
            <ol>
              {% spaceless %}
              {% with nofo.sections.all|dictsort:"order" as nav_sections %}
                <li><a href="#section--{{ nav_sections.0.html_id }}" {% if nav_sections.0.html_id == section.html_id %}aria-current="step"{% endif %}>Review</a></li>
                <li><a href="#section--{{ nav_sections.1.html_id }}" {% if nav_sections.1.html_id == section.html_id %}aria-current="step"{% endif %}>Get Ready</a></li>
                <li><a href="#section--{{ nav_sections.2.html_id }}" {% if nav_sections.2.html_id == section.html_id %}aria-current="step"{% endif %}>{% if 'Write' in nav_sections.2.name %}Write{% else %}Prepare{% endif %}</a></li>
                <li><a href="#section--{{ nav_sections.3.html_id }}" {% if nav_sections.3.html_id == section.html_id %}aria-current="step"{% endif %}>Learn</a></li>
                <li><a href="#section--{{ nav_sections.4.html_id }}" {% if nav_sections.4.html_id == section.html_id %}aria-current="step"{% endif %}>Submit</a></li>
                <li><a href="#section--{{ nav_sections.5.html_id }}" {% if nav_sections.5.html_id == section.html_id %}aria-current="step"{% endif %}>Award</a></li>
                <li><a href="#section--{{ nav_sections.6.html_id }}" {% if nav_sections.6.html_id == section.html_id %}aria-current="step"{% endif %}>Contacts</a></li>
              {% endwith %}
              {% endspaceless %}
            </ol>
          </div>
          <div class="section--title-page--name">
            <div class="section--title-page--icon">
              {% include "includes/icon_macro.html" with section_name=section.name|lower only %}
            </div>
            <h2 id="{{ section.html_id }}">
              {% with section.name|nofo_section_name_separator as section_name %}
                {% if section_name.number %}
                  <span>Step {{ section_name.number }}:</span>
                  <br >
                {% endif %}
                <span>{{ section_name.name }}</span>
              {% endwith %}
            </h2>
          </div>
          <div class="section--title-page--toc">
            <p>In this step</p>
            <ul>
              {% spaceless %}
              {% for subsection in section.subsections.all|dictsort:"order" %}
                {% with tag=subsection.tag content=subsection.name id=subsection.html_id %}
                  {% if tag == 'h3' %}
                    <li><a href="#{{ subsection.html_id }}">{{ content }}</a></li>
                  {% endif %}
                {% endwith %}
              {% endfor %}
              {% endspaceless %}
            </ul>
          </div>
        </div>
      {% endif %}

      <!-- RUNNING HEADER -->
      <!-- after first section title page -->
      <div class="header-nav header-nav--running-header">
        <ol>
          {% with nofo.sections.all|dictsort:"order" as nav_sections %}
              <li><a href="#section--{{ nav_sections.0.html_id }}" {% if nav_sections.0.html_id == section.html_id %}aria-current="step"{% endif %}>Review</a></li>
              <li><a href="#section--{{ nav_sections.1.html_id }}" {% if nav_sections.1.html_id == section.html_id %}aria-current="step"{% endif %}>Get Ready</a></li>
              <li><a href="#section--{{ nav_sections.2.html_id }}" {% if nav_sections.2.html_id == section.html_id %}aria-current="step"{% endif %}>{% if 'Write' in nav_sections.2.name %}Write{% else %}Prepare{% endif %}</a></li>
              <li><a href="#section--{{ nav_sections.3.html_id }}" {% if nav_sections.3.html_id == section.html_id %}aria-current="step"{% endif %}>Learn</a></li>
              <li><a href="#section--{{ nav_sections.4.html_id }}" {% if nav_sections.4.html_id == section.html_id %}aria-current="step"{% endif %}>Submit</a></li>
              <li><a href="#section--{{ nav_sections.5.html_id }}" {% if nav_sections.5.html_id == section.html_id %}aria-current="step"{% endif %}>Award</a></li>
              <li><a href="#section--{{ nav_sections.6.html_id }}" {% if nav_sections.6.html_id == section.html_id %}aria-current="step"{% endif %}>Contacts</a></li>
            {% endwith %}
        </ol>
      </div>

      <!-- SECTION CONTENT -->
      <div class="section--content">
        {% if not section.has_section_page %}
          {% include "includes/heading.html" with tag="h2" content=section.name id=section.html_id only %}
        {% endif %}
        <!-- for the very first subsection, add the nofo agency, subagency, and tagline -->
        {% if section.order == 1 %}
          {% with first_subsection=nofo.get_first_subsection %}
            {% with tag=first_subsection.tag content=first_subsection.name id=first_subsection.html_id %}
              {% include "includes/heading.html" with tag=tag content=content id=id only %}
            {% endwith %}
              <div class="section--content--intro">
              <p><strong>{{ nofo.opdiv }}</strong></p>
              <p>{{ nofo.agency }}</p>
              {% if nofo.subagency %}<p>{{ nofo.subagency }}</p>{% endif %}
              {% if nofo.subagency2 %}<p>{{ nofo.subagency2 }}</p>{% endif %}
              {% if nofo.tagline %}<div class="nofo--tagline">{{ nofo.tagline|safe_markdown }}</div>{% endif %}
            </div>
          {% endwith %}
        {% endif %}

        <!-- if in portrait mode, add callout boxes in right margin -->
        {% if nofo_theme_orientation == 'portrait' %}
          <div class="section--absolute--right-col">
            {% for subsection in section.subsections.all|dictsort:"order" %}
              {% if subsection.callout_box and subsection|is_floating_callout_box %}
                {% include "includes/callout_box.html" with subsection=subsection nofo=nofo break_colons=True only %}
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}

        <!-- loop through remaining subsections as usual -->
        {% for subsection in section.subsections.all|dictsort:"order" %}
          {% if subsection.callout_box %}
            {% if nofo_theme_orientation == 'portrait' %}
              {% if not subsection|is_floating_callout_box %}
                {% include "includes/callout_box.html" with subsection=subsection nofo=nofo break_colons=False only %}
              {% endif %}
            {% else %}
              {% include "includes/callout_box.html" with subsection=subsection nofo=nofo only %}
            {% endif %}
          {% else %}
            {% if subsection.name|lower != 'basic information' %}
              {% with tag=subsection.tag content=subsection.name id=subsection.html_id class=subsection.html_class %}
                {% include "includes/heading.html" with tag=tag content=content id=id class=class only %}
              {% endwith %}
                {{ subsection.body|safe_markdown|add_classes_to_tables|replace_unicode_with_icon|add_footnote_ids|add_classes_to_paragraphs|add_captions_to_tables|add_classes_to_lists|convert_paragraphs_to_hrs }}
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </section>
  {% endfor %}
{% endblock %}
